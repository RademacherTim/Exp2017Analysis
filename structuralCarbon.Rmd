---
title: 'Scaling structural carbon (SI 1)'
author: Tim Rademacher
date: "01/11/2019"
output: html_document
bibliography: "/home/trademacehr/projects/PlantGrowth/bib/Exp2017.bib"
csl: "/home/trademacehr/projects/PlantGrowth/bib/harvard.csl"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library ('knitr')
library ('tidyverse')
library ('lubridate')
library ('readxl')
library ('googledrive')
library ('rjson')
library ('plotrix')
library ('zoo')

# Specify the user:
options (gargle_oauth_email = "tr625@nau.edu")

# set colour scheme for control, girdled, compressed, double compressed and chilled
colours <- c ('#91b9a4','#C0334D','#F18904','#5C4A72','#23345C')
#colours <- c ('','#ea7125','#8f2bbc','#d6083b','#0072cf')

options (warn = -1)
```

## Structural carbon estimation for stem sections of the 2017 experiment at Harvard Forest

``` {r getData, echo = FALSE}
# Get list of folder on shared PlantGrowth google drive
GDFolders  <- drive_ls (path = 'https://drive.google.com/drive/u/1/folders/0ABA0-TtlzSLPUk9PVA')

# Get id for data folder on shared PlantGrowth google drive
GDDataID <- GDFolders [['id']] [GDFolders [['name']] == 'data']

# Get list of folders in data folder
GDFoldersData <- drive_ls (path = as_id (GDDataID))

# Get microcores folder id
GDmicrocoresID <- GDFoldersData [['id']] [GDFoldersData [['name']] == 'microcores']

# Get list of folders in micrcores folder
GDFoldersMicrocores <- drive_ls (path = as_id (GDmicrocoresID))

# Get woodAnatomy folder id
GDwoodAnatomyID <- GDFoldersMicrocores [['id']] [GDFoldersMicrocores [['name']] == 'woodAnatomy']

# Get list of folders in woodAnatomy folder
GDFoldersWoodAnatomy <- drive_ls (path = as_id (GDwoodAnatomyID))

# Get Exp2017 folder id
GDExp2017ID <- GDFoldersWoodAnatomy [['id']] [GDFoldersWoodAnatomy [['name']] == 'Exp2017']

# Get list of files in Exp2017 folder
GDFilesExp2017 <- drive_ls (path = as_id (GDExp2017ID))

# Get id of file with data for 20 mu band anatomical averages
GDExp2017FileID <- GDFilesExp2017 [['id']] [GDFilesExp2017 [['name']] == '20muband_ALL.xlsx']

# Get id of folder with ring width measurements from TRIAD
GDFolderringWidthTRIADID <- GDFilesExp2017 [['id']] [GDFilesExp2017 [['name']] == 'ringWidthTRIAD']

# Get list of ids for all ringwidth measurements
GDringWidthFilesIDs <- drive_ls (path = as_id (GDFolderringWidthTRIADID))

# Identify allometry folder
GDallometryID <- GDFoldersData [['id']] [GDFoldersData [['name']] == 'allometry']

# List files in allometry folder
GDFilesAllometry <- drive_ls (path = as_id (GDallometryID))

# Identify id of file with allometry data for the 2017 Experiment
GDExp2017AllometryFileID <- GDFilesAllometry [['id']] [GDFilesAllometry [['name']] == 'allometricDataExp2017.xlsx']

# Change working directory
setwd ('/media/TREE/PlantGrowth/data/microcores/woodAnatomy/Exp2017/')

# Download the Exp2017 wood anatomical data file
# fileExp2017 <- drive_download (file = as_id (GDExp2017FileID), verbose = FALSE, overwrite = TRUE)
# rm (fileExp2017)

# Read the data per 20 micron slices
data <- read_excel (path = paste0 (getwd (),'/20muband_ALL.xlsx'), 
                    sheet = '20muband_ALL', 
                    na = "NA")

# Change working directory
setwd ('/media/TREE/PlantGrowth/data/microcores/woodAnatomy/Exp2017/ringWidthTRIAD/')

# Download the files for ring width measurements of the Exp 2017 microcores
# for (i in 1:dim (GDringWidthFilesIDs) [1]) {
#   fileExp2017 <- drive_download (file = as_id (GDringWidthFilesIDs [['id']] [i]), verbose = FALSE, overwrite = TRUE)
#   rm (fileExp2017)
#   print (i)
# }

# Change working directory
setwd ('/media/TREE/PlantGrowth/data/allometry/')

# Download the Exp2017 allometry data file
# fileExp2017 <- drive_download (file = as_id (GDExp2017AllometryFileID), verbose = FALSE, overwrite = TRUE)
# rm (fileExp2017)

# Read the allometric data
allometricData <- read_excel (path = paste0 (getwd (),'/allometricDataExp2017.xlsx'), 
                              sheet = 'allometricData', 
                              na = "NA")

# Reset the working directory
setwd ('/home/trademacehr/projects/PlantGrowth/Exp2017/Exp2017Analysis/')
```

The estimation of structural carbon gain for each stem section is scaled from the cell wall area of one thinsections sampled at the end of the growing season (3$^{rd}$ of November 2017) and divided into sections grown in each period (e.g., prior, during and after treatment) by association with the proportion of the ring formed at the time. Each sampling date two thinsection were collected and stored in solution (75% ethanol and 25% glacial acedic acid). Where the first thinsection did not fully include the necessary rings or had other quality issues, we cut and processed the second microcore. Between the two microcores, we were able to obtain high-quality image data for 314<!-- TR - Image 06.1 M for 2017/08/09 only contains part of the 2017 ring. And images 06.1 M, 24.4 A and 24.4 B are missing the 2015 ring. There must be two additional rings missing because the numbferOfSamples suggests so!!!--> out of 320 samples (i.e., 4 sampling dates times 40 trees times on average two sampling heights). Only for one tree (tree id: 06; treament: control) both thinsections collected in October did not contain a full set of rings necessary for the analysis. For each image, we identified and divided the ring formed in 2017 into 20 micron-wide discrete zones and derived the average anatomical structure for a cell in each zone using ROXAS [@von_arx_roxas_2014]. In particular, we measured cell wall area, cell wall thickness, as well as tangential and radial cell width. The ring width of the fully formed ring ranged between `r round (range (unique (data [['MRW']] [data [['YEAR']] == 2017])) [1]/1000, 2)` and `r round (range (unique (data [['MRW']] [data [['YEAR']] == 2017])) [2] / 1000, 2 )`mm with a mean of `r round (mean (unique (data [['MRW']] [data [['YEAR']] == 2017]))/1000, 2)`mm. Thus event he smallest ring was divided into, at least, `r round (range (unique (data [['MRW']] [data [['YEAR']] == 2017])) [1]/20)` discrete zones with anatomical data.

### Dividing cell wall area by period of formation

Standardised ring widths from the thinsections collected at the end of each period, were used to associate proportions of the ring, thus 20-micron wide zones, to specific growth periods. For this purpose we identified and measured ring widths in thinsections taken prior (e.g., 3$^{rd}$ of July 2017) and during the treatment (e.g., 10$^{th}$ of August 2017, and 9$^{th}$ of October 2017), as well as at the end of the growing season (3$^{rd}$ of November). All ring width measurements were performed with the Tree Ring Image Analysis and Database (TRIAD). The accuracy of TRIAD is limited by the resolution of the uploaded images; here roughly 1.5 microns. 

``` {r getRingWidths, echo = FALSE}
# build data frame with ring width measurements for each of the four thinsections
ringWidths <- tibble (tree = rep (1:40, 4),
                      treatment = rep (allometricData [['treatment']] [1:40], 4),
                      month = c (rep (7, 40), rep (8, 40), rep (10, 40), rep (11, 40)),
                      RW2017at250 = NA, RW2017at200 = NA, RW2017at150 = NA, RW2017at100 = NA, RW2017at050 = NA,
                      RW2016at250 = NA, RW2016at200 = NA, RW2016at150 = NA, RW2016at100 = NA, RW2016at050 = NA,
                      RW2015at250 = NA, RW2015at200 = NA, RW2015at150 = NA, RW2015at100 = NA, RW2015at050 = NA,
                      RW2014at250 = NA, RW2014at200 = NA, RW2014at150 = NA, RW2014at100 = NA, RW2014at050 = NA,
                      RW2013at250 = NA, RW2013at200 = NA, RW2013at150 = NA, RW2013at100 = NA, RW2013at050 = NA,
                      RW2012at250 = NA, RW2012at200 = NA, RW2012at150 = NA, RW2012at100 = NA, RW2012at050 = NA,
                      RW2011at250 = NA, RW2011at200 = NA, RW2011at150 = NA, RW2011at100 = NA, RW2011at050 = NA,
                      RW2010at250 = NA, RW2010at200 = NA, RW2010at150 = NA, RW2010at100 = NA, RW2010at050 = NA,
                      RW2009at250 = NA, RW2009at200 = NA, RW2009at150 = NA, RW2009at100 = NA, RW2009at050 = NA,
                      RW2008at250 = NA, RW2008at200 = NA, RW2008at150 = NA, RW2008at100 = NA, RW2008at050 = NA)


# set working directory to read json files
setwd ('/media/TREE/PlantGrowth/data/microcores/woodAnatomy/Exp2017/ringWidthTRIAD/')

# list all json output file from TRIAD
jsonFiles <- list.files (path = './', pattern = '.json')

# set loop variable to count files with 2018 year growth
k <- 0

# loop over json files and read them
for (j in 1: length (jsonFiles)) {
  
  # read in TRIAD outputs
  temp <- fromJSON (file = jsonFiles [j]) 
  treeID <- as.numeric (substr (temp [['sampleID']], 1, 2))
  sampleDate <- lubridate::month (temp [['sampleDate']])
  len <- length (temp [['growth']])
  # print (c (j, treeID, sampleDate))
  for (i in 1:len) {
    if (i  == 1) {
      types  <- unlist (temp [['growth']] [i]) [6]
      years  <- unlist (temp [['growth']] [i]) [7] 
      growth <- unlist (temp [['growth']] [i]) [9]
    } else {
      types  <- c (types,  unlist (temp [['growth']] [i]) [6])
      years  <- c (years,  unlist (temp [['growth']] [i]) [7])
      growth <- c (growth, unlist (temp [['growth']] [i]) [9])
    }
  }
  if (max (years) == 2017 & growth [years == '2017' & types == 'Normal'] == '0') {
    print (paste0 ('Error with the year number 2017 for:', jsonFiles [j]))
  } else if (max (years) >= 2017 & growth [years == '2018' & types == 'Normal'] != '0') {
    k <- k + 1
    print (paste0 (jsonFiles [j],' has a 2018, CHECK IT!!!', max (years),' file number ', k))
  }
  growth <- as.numeric (growth [types == 'Normal' & years <= 2017])
  years  <- as.numeric (years  [types == 'Normal' & years <= 2017])
  growth <- c (growth, rep (NA, 10-length (growth)))
  years  <- c (years,  seq (years [length (years)]-1, 2008))
      
  t <- as.numeric (substr (temp [['sampleID']], 4, 4))
  if (t == 1) {
    if (!is.na (growth [years == 2017])) {
      ringWidths [['RW2017at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2017]
    }
    if (!is.na (growth [years == 2016])) {
      ringWidths [['RW2016at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2016]
    }
    if (!is.na (growth [years == 2015])) {
      ringWidths [['RW2015at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2015]
    }
    if (!is.na (growth [years == 2014])) {
      ringWidths [['RW2014at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2014]
    }
    if (!is.na (growth [years == 2013])) {
      ringWidths [['RW2013at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2013]
    }
    if (!is.na (growth [years == 2012])) {
      ringWidths [['RW2012at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2012]
    }
    if (!is.na (growth [years == 2011])) {
      ringWidths [['RW2011at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2011]
    }
    if (!is.na (growth [years == 2010])) {
      ringWidths [['RW2010at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2010]
    }
    if (!is.na (growth [years == 2009])) {
      ringWidths [['RW2009at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2009]
    }
    if (!is.na (growth [years == 2008])) {
      ringWidths [['RW2008at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2008]
    }
  } else if (t == 2 | t == 3) {
    sampleHeight <- substr (temp [['sampleID']], 6, 6)
    if (sampleHeight == 'A') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at200']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at200']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at200']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    } else if (sampleHeight == 'B') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at100']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at100']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at100']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    }
  } else if (t == 4) {
    sampleHeight <- substr (temp [['sampleID']], 6, 6)
    if (sampleHeight == 'A') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at250']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at250']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at250']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }  
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    } else if (sampleHeight == 'M') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at150']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at150']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at150']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    } else if (sampleHeight == 'B') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at050']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at050']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at050']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    }
  }
}  # end json file loop

# add November ring width to the ringWidths tibble
for (i in 1:dim (data) [1]) {
  treeID       <- as.numeric (substr (data [['TREE']] [i], 1, 2))
  treatment    <- as.numeric (substr (data [['PLOT']] [i], 2, 2))
  sampleHeight <- data [['POS']] [i]
  sampleDate <- 11
  year <- data [['YEAR']] [i]
  if (sampleHeight == 'A' & treatment == 4) {
    height <- '250' 
  } else if (sampleHeight == 'A' & (treatment == 2 | treatment == 3)) {
    height <- '200' 
  } else if (sampleHeight == 'M') {
    height <- '150'
  } else if (sampleHeight == 'B' & (treatment == 2 | treatment == 3)) {
    height <- '100'
  } else if (sampleHeight == 'B' & treatment == 4) {
    height <- '050'
  }
  xTemp <- paste0 ('RW',year,'at',height)
  ringWidths [[xTemp]] [ringWidths [['tree']] == treeID & 
                        ringWidths [['month']] == sampleDate] <- as.numeric (data [['MRW']] [i]) * 1.0e-3
}

# Reset the working directory
setwd ('/home/trademacehr/projects/PlantGrowth/Exp2017/Exp2017Analysis/')
```

As growth varies locally around the circumference of the stem, we tried to account for local circumferential variations in growth by standardisation with the 2015 ring width fromt the same thinsection. 

$$
f_{2017,i} = \frac {rw_{2017,i} \times rw_{2015,Nov}} {rw_{2015,i}} \times \frac{1} {rw_{2017,Nov}}
$$
, where $rw_{2015,Nov}$ and $rw_{2015,Nov}$ are respectively the 2015 and 2017 ring widths as measured at the end of the growing season. This assumes that the ring was fully formed on the 1$^{st}$ of November, which is about two weeks after the typical end of cell wall thickening for white pine at Harvard Forest. Then, $f_{2017,i}$ theoretically varies between 0 and 1 with 0 meaning non of the ring was formed at the sampling date and 1 meaning that the entire ring was already formed.

```{r climateData, echo = FALSE}
metData <- read_csv (url ('https://harvardforest.fas.harvard.edu/data/p30/hf300/hf300-01-annual-m.csv'), 
                     col_types = cols ())
```

The number of measurements for growth rings drops off strongly after the 2015 growth ring (table 1), because the older rings are further away from the bark, hence they are less likely within the 15mm reach of the trephor tool [@rossi_trephor:_2006] used to collect the thinsections. Among the recent years with high replication, 2015 was preferred over 2016, because of an abnormally dry growing season in 2016 (total annual precipitation of `r metData [['prec']] [metData [['year']] == 2016]` $mm$, which is `r round (mean (metData [['prec']]) - metData [['prec']] [metData [['year']] == 2016])` below the long-term average of `r round (mean (metData [['prec']]))` $mm$). In contrast the 2015 growing season climate was similar to the 2017 growing season climate with a mean annual temperature of `r metData [['airt']] [metData [['year']] == 2015]` $^{\circ}C$ and a total annual precipitation of `r metData [['prec']] [metData [['year']] == 2015]` $mm$. In fact, about three quraters of trees included in this study showed a intra-annual density fluctuation in 2016 due to the dry growing season and the remaining quarter of trees had a relatively narrower ring. Consequently, standardisation by the 2016 ring would introduce a systematic bias based on the bi-modal ring width distribution in 2016. In contrast, 2015 did not include any outstading climatological events or resulting systematic bias in growth.

``` {r plotBasicRingStats, echo = FALSE, fig.width = 11}
# Divide into tibble for each sampling date
ringWidthsJul <- ringWidths [ringWidths [['month']] == 7, ]
ringWidthsAug <- ringWidths [ringWidths [['month']] == 8, ]
ringWidthsOct <- ringWidths [ringWidths [['month']] == 10, ]
ringWidthsNov <- ringWidths [ringWidths [['month']] == 11, ]
#max (ringWidths [4:dim (ringWidths) [2]], na.rm = TRUE)

# Get mean 2017 growth for each month for all treatments
# mean (colMeans (ringWidthsJul [4:8], na.rm = TRUE)) # 0.914724
# mean (colMeans (ringWidthsAug [4:8], na.rm = TRUE)) # 1.437826
# mean (colMeans (ringWidthsOct [4:8], na.rm = TRUE)) # 1.677127
# mean (colMeans (ringWidthsNov [4:8], na.rm = TRUE)) # 1.7327

# Get mean growth per treatment for each month
# colMeans (ringWidthsJul [ringWidthsJul [['treatment']] == 1, 4:8], na.rm = TRUE)
# colMeans (ringWidthsAug [ringWidthsAug [['treatment']] == 1, 4:8], na.rm = TRUE)
# colMeans (ringWidthsOct [ringWidthsOct [['treatment']] == 1, 4:8], na.rm = TRUE)
# colMeans (ringWidthsNov [ringWidthsNov [['treatment']] == 1, 4:8], na.rm = TRUE)


# colMeans (ringWidthsJul [ringWidthsJul [['treatment']] == 2, 4:8], na.rm = TRUE)
# colMeans (ringWidthsAug [ringWidthsAug [['treatment']] == 2, 4:8], na.rm = TRUE)
# colMeans (ringWidthsOct [ringWidthsOct [['treatment']] == 2, 4:8], na.rm = TRUE)
# colMeans (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 4:8], na.rm = TRUE)

# colMeans (ringWidthsJul [ringWidthsJul [['treatment']] == 3, 4:8], na.rm = TRUE)
# colMeans (ringWidthsAug [ringWidthsAug [['treatment']] == 3, 4:8], na.rm = TRUE)
# colMeans (ringWidthsOct [ringWidthsOct [['treatment']] == 3, 4:8], na.rm = TRUE)
# colMeans (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 4:8], na.rm = TRUE)

# colMeans (ringWidthsJul [ringWidthsJul [['treatment']] == 4, 4:8], na.rm = TRUE)
# colMeans (ringWidthsAug [ringWidthsAug [['treatment']] == 4, 4:8], na.rm = TRUE)
# colMeans (ringWidthsOct [ringWidthsOct [['treatment']] == 4, 4:8], na.rm = TRUE)
# colMeans (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 4:8], na.rm = TRUE)

dJul <- density (unlist (ringWidthsJul [4:8]), na.rm = T)
dAug <- density (unlist (ringWidthsAug [4:8]), na.rm = T)
dOct <- density (unlist (ringWidthsOct [4:8]), na.rm = T)
dNov <- density (unlist (ringWidthsNov [4:8]), na.rm = T)

# Plot density kernels
layout (matrix (1:2, nrow = 1))
par (mar = c (5, 5, 3, 1))
plot (dJul, xlab = 'ring width (mm)', ylab = 'density',
      xlim = c (0, 5.5), ylim = c (0, 1), main = 'Raw Ring Widths', 
      col = '#018571', lwd = 2, las = 1)
lines (dAug, col = '#80cdc1', lwd = 2)
lines (dOct, col = '#dfc27d', lwd = 2)
lines (dNov, col = '#a6611a', lwd = 2)
legend (x = 2.1, y = 1.02, legend = c ('July','August','October','November'),
        col = c ('#018571', '#80cdc1', '#dfc27d', '#a6611a'),
        lwd = 2, box.lty = 0, bg = 'transparent')

# Compare mean 2016 growth 
# mean (colMeans (ringWidthsJul [9:13], na.rm = TRUE))
# mean (colMeans (ringWidthsAug [9:13], na.rm = TRUE))
# mean (colMeans (ringWidthsOct [9:13], na.rm = TRUE))
# mean (colMeans (ringWidthsNov [9:13], na.rm = TRUE))
# dJul <- density (unlist (ringWidthsJul [9:13]), na.rm = T)
# dAug <- density (unlist (ringWidthsAug [9:13]), na.rm = T)
# dOct <- density (unlist (ringWidthsOct [9:13]), na.rm = T)
# dNov <- density (unlist (ringWidthsNov [9:13]), na.rm = T)
# plot (dJul, xlab = 'ring width (mm)', ylab = 'density',
#       xlim = c (0, 5.5), ylim = c (0, 0.5), main = '2016', 
#       col = '#018571', lwd = 2, las = 1)
# lines (dAug, col = '#80cdc1', lwd = 2)
# lines (dOct, col = '#dfc27d', lwd = 2)
# lines (dNov, col = '#a6611a', lwd = 2)
# legend (x = 2.5, y = 0.51, legend = c ('July','August','October','November'),
#         col = c ('#018571', '#80cdc1', '#dfc27d', '#a6611a'),
#         lwd = 2, box.lty = 0, bg = 'transparent')

# Compare mean 2015 growth 
# mean (colMeans (ringWidthsJul [14:18], na.rm = TRUE))
# mean (colMeans (ringWidthsAug [14:18], na.rm = TRUE))
# mean (colMeans (ringWidthsOct [14:18], na.rm = TRUE))
# mean (colMeans (ringWidthsNov [14:18], na.rm = TRUE))
# dJul <- density (unlist (ringWidthsJul [14:18]), na.rm = T)
# dAug <- density (unlist (ringWidthsAug [14:18]), na.rm = T)
# dOct <- density (unlist (ringWidthsOct [14:18]), na.rm = T)
# dNov <- density (unlist (ringWidthsNov [14:18]), na.rm = T)
# plot (dJul, xlab = 'ring width (mm)', ylab = 'density',
#       xlim = c (0, 5.5), ylim = c (0, 0.5), main = '2015', 
#       col = '#018571', lwd = 2, las = 1)
# lines (dAug, col = '#80cdc1', lwd = 2)
# lines (dOct, col = '#dfc27d', lwd = 2)
# lines (dNov, col = '#a6611a', lwd = 2)
# legend (x = 2.5, y = 0.51, legend = c ('July','August','October','November'),
#         col = c ('#018571', '#80cdc1', '#dfc27d', '#a6611a'),
#         lwd = 2, box.lty = 0, bg = 'transparent')

# Plot standardised ring widths in November to look for treatment effect in 2017
dNov1M <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 1, 6] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 1, 16]), na.rm = T)
dNov2A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 5] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 2, 15]), na.rm = T)
dNov2B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 7] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 2, 17]), na.rm = T)
dNov3A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 5] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 3, 15]), na.rm = T)
dNov3B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 7] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 3, 17]), na.rm = T)
dNov4A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 4] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 4, 14]), na.rm = T)
dNov4M <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 6] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 4, 16]), na.rm = T)
dNov4B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 8] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 4, 18]), na.rm = T)

# Plot density kernel of ring widths in 2017 and 2015 by treatment
par (mar = c (5, 5, 3, 1))
#layout (matrix (1:4, nrow = 2), height = c (1.5, 1, 1.5, 1))
plot (dNov1M, col = colours [1], lwd = 2, ylim = c (0, 2), las = 1,
      xlab = 'ring width (mm)',
      ylab = 'density', main = 'Standardised Ring Widths',
      xlim = c (0, 3))
lines (dNov2A, col = colours [2], lwd = 2)
lines (dNov2B, col = colours [2], lwd = 2, lty = 2)
lines (dNov3A, col = colours [3], lwd = 2)
lines (dNov3B, col = colours [3], lwd = 2, lty = 2)
lines (dNov4A, col = colours [4], lwd = 2)
lines (dNov4B, col = colours [4], lwd = 2, lty = 2)
lines (dNov4M, col = colours [4], lwd = 2, lty = 3)
legend (x = 1.35, y = 2, legend = c ('control','gridling','compression','double compression'),
        col = colours,
        lwd = 2, box.lty = 0, bg = 'transparent')
# boxplot (at = 6, x = ringWidthsNov [ringWidthsNov [['treatment']] == 1, 6] / 
#                            ringWidthsNov [ringWidthsNov [['treatment']] == 1, 16], 
#          col = colours [1], xlim = c (0, 7), ylim = c (0, 3),
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 2, 5] / 
#                            ringWidthsNov [ringWidthsNov [['treatment']] == 2, 15], 
#          col = colours [2], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 4.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 2, 7] / 
#                            ringWidthsNov [ringWidthsNov [['treatment']] == 2, 17], 
#          col = colours [2], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 3.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 3, 5] / 
#                            ringWidthsNov [ringWidthsNov [['treatment']] == 3, 15], 
#          col = colours [3], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 3, x = ringWidthsNov [ringWidthsNov [['treatment']] == 3, 7] / 
#                            ringWidthsNov [ringWidthsNov [['treatment']] == 3, 17], 
#          col = colours [3], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 2, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 4] / 
#                            ringWidthsNov [ringWidthsNov [['treatment']] == 4, 14], 
#          col = colours [4], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 1.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 6] / 
#                            ringWidthsNov [ringWidthsNov [['treatment']] == 4, 16], 
#          col = colours [4], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 1, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 8] / 
#                            ringWidthsNov [ringWidthsNov [['treatment']] == 4, 18], 
#          col = colours [4], add = T, 
#          axes = FALSE, horizontal = TRUE)

# Add a plot for 2015 
# dNov1M <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 1, 16]), na.rm = T)
# dNov2A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 15]), na.rm = T)
# dNov2B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 17]), na.rm = T)
# dNov3A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 15]), na.rm = T)
# dNov3B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 17]), na.rm = T)
# dNov4A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 14]), na.rm = T)
# dNov4M <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 16]), na.rm = T)
# dNov4B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 18]), na.rm = T)
# par (mar = c (5,5,3,1))
# plot (dNov1M, col = colours [1], lwd = 2, ylim = c (0, 1.2), las = 1,
#       xlab = 'ring width (mm)',
#       ylab = 'density', main = '2015',
#       xlim = c (0, 6))
# lines (dNov2A, col = colours [2], lwd = 2)
# lines (dNov2B, col = colours [2], lwd = 2, lty = 2)
# lines (dNov3A, col = colours [3], lwd = 2)
# lines (dNov3B, col = colours [3], lwd = 2, lty = 2)
# lines (dNov4A, col = colours [4], lwd = 2)
# lines (dNov4B, col = colours [4], lwd = 2, lty = 2)
# lines (dNov4M, col = colours [4], lwd = 2, lty = 3)
# boxplot (at = 6, x = ringWidthsNov [ringWidthsNov [['treatment']] == 1, 16], 
#          col = colours [1], xlim = c (0, 7), ylim = c (0, 6),
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 2, 15], 
#          col = colours [2], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 4.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 2, 17], 
#          col = colours [2], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 3.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 3, 15], 
#          col = colours [3], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 3, x = ringWidthsNov [ringWidthsNov [['treatment']] == 3, 17], 
#          col = colours [3], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 2, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 14], 
#          col = colours [4], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 1.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 16], 
#          col = colours [4], add = T, 
#          axes = FALSE, horizontal = TRUE)
# boxplot (at = 1, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 18], 
#          col = colours [4], add = T, 
#          axes = FALSE, horizontal = TRUE)

# Calculate the fractions of ring formed
f_Jul <- (ringWidthsJul [4:8] / ringWidthsJul [14:18]) * ringWidthsNov [14:18] / ringWidthsNov [4:8] 
f_Aug <- (ringWidthsAug [4:8] / ringWidthsAug [14:18]) * ringWidthsNov [14:18] / ringWidthsNov [4:8] 
f_Oct <- (ringWidthsOct [4:8] / ringWidthsOct [14:18]) * ringWidthsNov [14:18] / ringWidthsNov [4:8] 
# Samples with only a partial 2015 ring are currently set to NAs
# TR - I need to deal with November samples that only have a partial measurement of the 2015 ring (06.1M, 11.2A, 24.4A, 24.4B)

# standardised ring width at the end of the season
standardisedRW2017 <- ringWidthsNov [4:8] / ringWidthsNov [14:18]
  
WRITE <- FALSE
if (WRITE) {
  write_csv (standardisedRW2017,  path = 'standardisedRW2017.csv')
}

# Aggregate the fractional growth by treatment
f_Agg <- aggregate (f_Jul, mean, by = list (allometricData [['treatment']] [1:40]), na.rm = TRUE)
f_Agg <- rbind (f_Agg, aggregate (f_Aug, mean, by = list (allometricData [['treatment']] [1:40]), na.rm = TRUE))
f_Agg <- rbind (f_Agg, aggregate (f_Oct, mean, by = list (allometricData [['treatment']] [1:40]), na.rm = TRUE))
f_Agg <- cbind (f_Agg, c (rep (7, 4), rep (8, 4), rep (10,4)))
names (f_Agg) <- c ('treatment', names (f_Agg [,2:6]),'month')
```

```{r tableWithNumberOfSamples, echo = FALSE, results = 'asis'}
# check how many images with data I have for each year
numberOfSamples <- colSums (!is.na (ringWidths [,4:dim (ringWidths) [2]]), na.rm = T)
numberOfSamples <- round (c (sum (numberOfSamples [1:5]),   sum (numberOfSamples [6:10]),  
                             sum (numberOfSamples [11:15]), sum (numberOfSamples [16:20]),
                             sum (numberOfSamples [21:25]), sum (numberOfSamples [26:30]),
                             sum (numberOfSamples [31:35]), sum (numberOfSamples [36:40]), 
                             sum (numberOfSamples [41:55], na.rm = T), sum (numberOfSamples [46:50])))
names (numberOfSamples) <- c (2017:2008)
numberOfSamples <- rbind (numberOfSamples, round (numberOfSamples / 320 * 100, 2))
numberOfSamples <- rbind (numberOfSamples, c (mean (colMeans (ringWidthsNov [4:8], na.rm = TRUE)),   # 2017
                                              mean (colMeans (ringWidthsNov [9:13], na.rm = TRUE)),  # 2016
                                              mean (colMeans (ringWidthsNov [14:18], na.rm = TRUE)),  # 2015
                                              mean (colMeans (ringWidthsNov [19:23], na.rm = TRUE)),  # 2014
                                              mean (colMeans (ringWidthsNov [24:28], na.rm = TRUE)),  # 2013
                                              mean (colMeans (ringWidthsNov [29:33], na.rm = TRUE)),  # 2012
                                              mean (colMeans (ringWidthsNov [34:38], na.rm = TRUE)),  # 2011
                                              mean (colMeans (ringWidthsNov [39:43], na.rm = TRUE)),  # 2010
                                              mean (colMeans (ringWidthsNov [44:48], na.rm = TRUE)),  # 2009
                                              mean (colMeans (ringWidthsNov [49:53], na.rm = TRUE)))) # 2008
rownames (numberOfSamples) <- c ('Number of Samples', 'Percentage', 'Mean Ring Width (mm)')
numberOfSamples [1, ] <- round (numberOfSamples [1, ])
numberOfSamples [2, ] <- round (numberOfSamples [2, ], 1)
numberOfSamples [3, ] <- round (numberOfSamples [3, ], 2)
# Add mean ring widths for each year and maybe percentage of possible samples 
kable (numberOfSamples, caption = 'Number of measured growth ring widths for all trees out of a potential 320 thinsection images.')
```

On average, `r round (mean (unlist (f_Jul), na.rm = TRUE) * 100.0, 1)`%, `r round (mean (unlist (f_Aug), na.rm = TRUE) * 100.0, 1)`%, and `r round (mean (unlist (f_Oct), na.rm = TRUE) * 100.0, 1)`% of the ring width had respectively grown in July, August and October. Thus, a bit more than half of the ring widths was already formed before the start of the treatment and ring width growth had <i>de facto</i> finished by Ocotober. However, there were substantial differences between treatments and sampling heights for August and October.  

### Associate cell wall area in final ring with period

Using the fractional ring widths as boundaries, each 20-micron zone was associated with one of the four periods: (i) beginning of growing season to start of experiment ($3^{rd}$ of July 2017), (ii) first month of the experiment ($4^{th}$ of July to $9^{th}$ of August 2017), (iii) second month of the experiment ($10^{th}$ of August to $8^{th}$ of October 2017), (iv) end of double compression to end of growing season ($9^{th}$ of October to $3^{rd}$ of November 2017).

``` {r cellularData, echo = FALSE}
# add new column to data
data <- add_column (data, period = NA)

# loop over for each row in the anatomical data to associate it with a growth period
for (i in 1:dim (data) [1]) {
  
  # if not 2017, skip
  if (data [['YEAR']] [i] != 2017) next
  
  # get tree ID, treatment and sample height of the sample
  treeID <- as.numeric (substr (data [['TREE']] [i], 1, 2))
  sampleHeight <- substr (data [['TREE']] [i], 3, 3)
  treatment <- as.numeric (substr (data [['PLOT']] [i], 2, 2))
  
  # get fractional boundaries for the particular sample
  if (sampleHeight == 'M') {
    fJul <- f_Jul [treeID, 3]
    fAug <- f_Aug [treeID, 3]
    fOct <- f_Oct [treeID, 3]
  } else if (treatment == 2 | treatment == 3) {
    if (sampleHeight == 'A') {
      fJul <- f_Jul [treeID, 2]
      fAug <- f_Aug [treeID, 2]
      fOct <- f_Oct [treeID, 2]
    } else if (sampleHeight == 'B') {
      fJul <- f_Jul [treeID, 4]
      fAug <- f_Aug [treeID, 4]
      fOct <- f_Oct [treeID, 4]
    }
  } else if (treatment == 4) {
    if (sampleHeight == 'A') {
      fJul <- f_Jul [treeID, 1]
      fAug <- f_Aug [treeID, 1]
      fOct <- f_Oct [treeID, 1]
    } else if (sampleHeight == 'B') {
      fJul <- f_Jul [treeID, 5]
      fAug <- f_Aug [treeID, 5]
      fOct <- f_Oct [treeID, 5]
    }
  }

  # associate fractional position with a period
  if (!is.na (data [['RRADDISTR']] [i])) {
    if (!is.na (fJul) & !is.na (fAug) & !is.na (fOct)) {
      if (data [['RRADDISTR']] [i] / 100 <= fJul) {
        data [['period']] [i] <- as_date ('2017-07-03')
      } else if (data [['RRADDISTR']] [i] / 100 <= fAug) {
        data [['period']] [i] <- as_date ('2017-08-09')
      } else if (data [['RRADDISTR']] [i] / 100 <= fOct) {
        data [['period']] [i] <- as_date ('2017-10-09')
      } else {
        data [['period']] [i] <- as_date ('2017-11-03')
      }
    }
  } else {
    fraction <- data [['RADDISTR.BAND']] [i] / data [['MRW']] [i]
    #print (c (fraction,treeID))
    if (!is.na (fJul) & !is.na (fAug) & !is.na (fOct)) {
      if (fraction <= fJul) {
        data [['period']] [i] <- as_date ('2017-07-03')
      } else if (fraction  <= fAug) {
        data [['period']] [i] <- as_date ('2017-08-09')
      } else if (fraction  <= fOct) {
        data [['period']] [i] <- as_date ('2017-10-09')
      } else {
        data [['period']] [i] <- as_date ('2017-11-03')
      }
    }
  }
}
```

### Scaling measured cell wall area to stem section 

After we associated each zone with a growth period, we scaled up from the zone cell dimensions and characteristics to the entire circumference of the stem section. Indeed, we multiplied the mean zonal cell wall area by the number of times the average zonal tangential cell width ($w_{t,s}$) fitted into the entire circumference of each stem section. To account for the bark (average bark thickness of 0.8 cm) we reduced the circumference, as measured at the beginning of the experiment ($CBH_{outer,s}$) according to the following equation:

$$
CBH_{s} = CBH_{outer,s} âˆ’ 0.8 cm \times 2 \pi
$$
To further scale the total circumferential cell wall area to a cell wall volume per stem section, we assume that the measured cell wall area ($CWA_{s,p}$) is representative taraplas for the stem section, hence we can simply multiply it with the height of the stem section (h = 10cm). 

$$
V_{CW,s,p} = \frac {CBH_{s}} {w_{t,s}} \times h_{s} \times \bar {CWA}
$$

The assumptions circumferential and taraplas representativeness of zonal averages derived from tracheids do not account for other types of tissue than tracheids, such as rays and resin ducts. Tracheids make up 93% of the volume of wood in white pines with resin ducts and rays  accounting for 1% and 6%, respectively [@brown_textbook_1949]. However, since there was no clear treatment effect on the occurance of resin ducts or rays cells, this assumption may only cause a slight over-estimation of structural carbon but no bias in carbon sequestration in strucutre between treatments. 

``` {r scalingToCircumference , echo = FALSE}
# add cell width column to data
data <- add_column (data, cellRadWidth = NA)
data <- add_column (data, cellTanWidth = NA)
data <- add_column (data, zonalCWA = NA)

# find multiplication factor for each radial band
for (i in 1:dim (data) [1]) {
    
  # if not 2017, skip
  if (data [['YEAR']] [i] != 2017) next
  
  # get treeID, treatment and sample height
  treeID <- as.numeric (substr (data [['TREE']] [i], 1, 2))
  sampleHeight <- substr (data [['TREE']] [i], 3, 3)
  treatment <- as.numeric (substr (data [['PLOT']] [i], 2, 2))

  # calculate zonal average tangential and radial cell width
  data [['cellRadWidth']] [i] <- data [['DRAD']] [i] + 2 * data [['CWTTAN']] [i] 
  data [['cellTanWidth']] [i] <- data [['DTAN']] [i] + 2 * data [['CWTRAD']] [i] 
  
  # factor to substract bark thickness
  
  
  # get circumference (microns) of the appropriate stem section
  if (sampleHeight == 'M') {
    circumference <- allometricData [['cbh150']] [allometricData [['tree']] == treeID] * 1.0e4
  } else if (treatment == 2 | treatment == 3) {
    if (sampleHeight == 'A') {
      circumference <- allometricData [['cbh200']] [allometricData [['tree']] == treeID] * 1.0e4
    } else if (sampleHeight == 'B') {
      circumference <- allometricData [['cbh100']] [allometricData [['tree']] == treeID] * 1.0e4
    }
  } else if (treatment == 4) {
    if (sampleHeight == 'A') {
      circumference <- allometricData [['cbh250']] [allometricData [['tree']] == treeID] * 1.0e4  
    } else if (sampleHeight == 'B') {
      circumference <- allometricData [['cbh50']] [allometricData [['tree']] == treeID] * 1.0e4
    }
  }
  
  # determine multiplier
  multiplier <- circumference / data [['cellRadWidth']] [i]
  
  # calculate new zonal cell wall area (microns2)
  data [['zonalCWA']] [i] <- data [['CWA']] [i] * multiplier
  
}
```

```{r sumZonalCWA, echo = FALSE}
# create circumferential cell wall area tibble 
circumferentialData <- tibble (tree = rep (1:40, 4),
                               period = c (rep (as_date ('2017-07-03'), 40), 
                                           rep (as_date ('2017-08-09'), 40), 
                                           rep (as_date ('2017-10-09'), 40), 
                                           rep (as_date ('2017-11-03'), 40)),
                               CWAat050 = NA, CWAat100 = NA, CWAat150 = NA, CWAat200 = NA, CWAat250 = NA) 

# loop over trees
for (iTree in 1:40) {
  
  # get treatment
  treatment <- unique (as.numeric (substr (data [['PLOT']] [as.numeric (substr (data [['TREE']], 1, 2)) == iTree], 2, 2)))
  
  # loop over periods
  for (iDate in as_date (c ('2017-07-03','2017-08-09','2017-10-09','2017-11-03'))) {
    
    # check which treatment to make sure we get the height right
    if (treatment == 1) {
      
      # condition for only height being "M"
      con <- as.numeric (substr (data [['TREE']], 1, 2)) == iTree & 
             data [['period']]                           == iDate & 
             data [['YEAR']]                             == 2017
      
      # sum zonal cell wall area (mm2) for each period
      circumferentialData [['CWAat150']] [circumferentialData [['tree']]   == iTree &
                                          circumferentialData [['period']] == iDate] <- sum (data [['zonalCWA']] [con], na.rm = T) / 1.0e6
    } else if (treatment == 2 | treatment == 3) {

      # condition for above
      con <- as.numeric (substr (data [['TREE']], 1, 2)) == iTree & 
             data [['period']]                           == iDate &
             data [['POS']]                              == 'A'   & 
             data [['YEAR']]                             == 2017
     
      # sum zonal cell wall area (mm2) for each period
      circumferentialData [['CWAat200']] [circumferentialData [['tree']]   == iTree &
                                          circumferentialData [['period']] == iDate] <- sum (data [['zonalCWA']] [con], na.rm = T) / 1.0e6
      
      # condition for above
      con <- as.numeric (substr (data [['TREE']], 1, 2)) == iTree & 
             data [['period']]                           == iDate &
             data [['POS']]                              == 'B'   & 
             data [['YEAR']]                             == 2017
      
      # sum zonal cell wall area (mm2) for each period
      circumferentialData [['CWAat100']] [circumferentialData [['tree']]   == iTree &
                                          circumferentialData [['period']] == iDate] <- sum (data [['zonalCWA']] [con], na.rm = T) / 1.0e6
    } else if (treatment == 4) {
      # condition for above
      con <- as.numeric (substr (data [['TREE']], 1, 2)) == iTree & 
             data [['period']]                           == iDate &
             data [['POS']]                              == 'A'   & 
             data [['YEAR']]                             == 2017
     
      # sum zonal cell wall area (mm2) for each period
      circumferentialData [['CWAat250']] [circumferentialData [['tree']]   == iTree &
                                          circumferentialData [['period']] == iDate] <- sum (data [['zonalCWA']] [con], na.rm = T) / 1.0e6
      
      # condition for middle
      con <- as.numeric (substr (data [['TREE']], 1, 2)) == iTree & 
             data [['period']]                           == iDate &
             data [['POS']]                              == 'M'   & 
             data [['YEAR']]                             == 2017
      
      # sum zonal cell wall area (mm2) for each period
      circumferentialData [['CWAat150']] [circumferentialData [['tree']]   == iTree &
                                          circumferentialData [['period']] == iDate] <- sum (data [['zonalCWA']] [con], na.rm = T) / 1.0e6
      
      # condition for above
      con <- as.numeric (substr (data [['TREE']], 1, 2)) == iTree & 
             data [['period']]                           == iDate &
             data [['POS']]                              == 'B'   & 
             data [['YEAR']]                             == 2017
      
      # sum zonal cell wall area (mm2) for each period
      circumferentialData [['CWAat050']] [circumferentialData [['tree']]   == iTree &
                                          circumferentialData [['period']] == iDate] <- sum (data [['zonalCWA']] [con], na.rm = T) / 1.0e6
    }
  }
}

# stem section height (m)
h <- 0.1

# create tibble for volume data
volumeData <- tibble (tree = rep (1:40, 4),
                      period = c (rep (as_date ('2017-07-03'), 40), 
                                  rep (as_date ('2017-08-09'), 40), 
                                  rep (as_date ('2017-10-09'), 40), 
                                  rep (as_date ('2017-11-03'), 40)),
                      CWVat050 = NA, CWVat100 = NA, CWVat150 = NA, CWVat200 = NA, CWVat250 = NA)

# cell wall volume (mm3)
volumeData [3:7] <- circumferentialData [3:7] * h * 1000
```

``` {r dryMatterAndCarbonContent, echo = FALSE}
# create tibble for dry matter in stem section
dryMatterData <- tibble (tree = rep (1:40, 4),
                         period = c (rep (as_date ('2017-07-03'), 40), 
                                     rep (as_date ('2017-08-09'), 40), 
                                     rep (as_date ('2017-10-09'), 40), 
                                     rep (as_date ('2017-11-03'), 40)),
                         DMat050 = NA, DMat100 = NA, DMat150 = NA, DMat200 = NA, DMat250 = NA)

# cell wall density (kg m-3)
rhoCW <- 1.489

# estimate dry matter (g)
dryMatterData [3:7] <- (volumeData [3:7] / 1.0e9) * rhoCW * 1.0e3

# create tibble for dry matter in stem section
carbonContentData <- tibble (tree = rep (1:40, 4),
                             period = c (rep (as_date ('2017-07-03'), 40), 
                                         rep (as_date ('2017-08-09'), 40), 
                                         rep (as_date ('2017-10-09'), 40), 
                                         rep (as_date ('2017-11-03'), 40)),
                             structuralCarbonat050 = NA, structuralCarbonat100 = NA, 
                             structuralCarbonat150 = NA, structuralCarbonat200 = NA, 
                             structuralCarbonat250 = NA)

# Carbon content of white pine wood (%)
CC <- 49.74

# estimate carbon content (g)
carbonContentData [3:7] <- dryMatterData [3:7] * CC / 100.0

# Export data if necessary
WRITE <- FALSE
if (WRITE) {
  write_csv (carbonContentData,  path = 'structuralCarbonData.csv')
}
```

Finally, the cell wall volume for each ring portion of the stem section ($V_{CW,s,p}$) is multiplied by a fixed cell wall density ($\rho_{CW}$) and carbon content () to estimate the total structural carbon gain per stem section and period ($M_{p,s}$ in g). Here, we use a cell wall density of `r rhoCW` $kgDM \, m^{âˆ’3}$ (measured for Scots pine by @plotze_porosity_2011) and carbon content of 49.74% for white pine [@lamlom_reassessment_2003].

$$
M_{s,p} = V_{CW,s,p} \times \rho_{CW} \times 49.74\%
$$

### Treatment effects on wood anatomy

``` {r plotAnatomy, echo= FALSE, fig.width = 11, fig.height = 11}
#========================================================================================
# Script to make Figure X
# 
# Manuscript: 
#
#
#
# Figure caption:
#   Wood anatomical properties of the 2017 and 2015 growing season. (a) Radial cell wall 
#   thickness, (b) cell lumen diameter and (c) number of cells are show for each sector 
#   and treatment (colour) of the growth ring for 2017 (solid lines) and 2015 (dashed 
#   lines). Each line represents the treatment mean (n = 10) with the standard deviation 
#   displayed as shading. 
#----------------------------------------------------------------------------------------

# add new column to data
data <- add_column (data, formationDate = NA)

# estimate date of formation for each zone
for (iDate in as_date (c ('2017-07-03','2017-08-09','2017-10-09','2017-11-03'))) {
  
  # loop over trees
  for (iTree in 1:40) {
    
    # get treatment and determine heights
    if (unique (data [['PLOT']] [as.numeric (substr (data [['TREE']], 1, 2)) == iTree]) == 'T1') {
      heights <-  c ('M')
    } else if (unique (data [['PLOT']] [as.numeric (substr (data [['TREE']], 1, 2)) == iTree]) == 'T2' |
               unique (data [['PLOT']] [as.numeric (substr (data [['TREE']], 1, 2)) == iTree]) == 'T3' ) {
      heights <-  c ('A', 'B')
    } else if (unique (data [['PLOT']] [as.numeric (substr (data [['TREE']], 1, 2)) == iTree]) == 'T4') {
      heights <-  c ('A', 'M', 'B')
    }
    
    # loop over sampling heights
    for (iHeight in heights) {
      
      if (iTree < 10) {
        treeID <- paste0 ('0',iTree,iHeight)
      } else {
        treeID <- paste0 (iTree, iHeight)
      }

      #curve to the four data points to estimate date of formation for any   
      
      # determine number of zones associated with each date
      condition <- data [['YEAR']] == 2017 & data [['TREE']] == treeID & data [['period']] == iDate
      numberOfZones <- sum (condition, na.rm = TRUE)
      
      # Divide period into equally into numberOfZones and associate a date of formation with each
      if (as_date (iDate) == '2017-07-03') {
        startDate <- as_date ('2017-03-01')
      } else if (as_date (iDate) == '2017-08-09') {
        startDate <- as_date ('2017-07-04')
      } else if (as_date (iDate) == '2017-10-09') {
        startDate <- as_date ('2017-08-10')
      } else if (as_date (iDate) == '2017-11-03') {
        startDate <- as_date ('2017-10-10')
      }
      if (numberOfZones > 0) {
        incr <- as.numeric (as_date (iDate) - startDate) / (numberOfZones - 1)
        data [['formationDate']] [condition] <- seq (startDate, as_date (iDate), by = incr)
      }  
    } # close height loop
    
  } # close tree loop
  
} # close period loop

# set window for rolling mean
window <- 61

# function to plot mean and standard deviation of the end of the growing season
plotEndOfGrowingSeason <- function (xPosition, treeLabels, colour, symbol) {
  
  # determine the last day of growth for each tree in the treatment
  lastDates <- aggregate (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                          by = list (data [['TREE']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                          max, na.rm = TRUE)
  lastDates [is.infinite (lastDates [, 2]), 2] <- NA
  
  # boxplot
  boxplot (at = xPosition,
           x = lastDates [[2]], xlab = 'estimated end of growth', ylab = '', horizontal = TRUE,
           col = colour)
}

# plot CWT of the 2017 ring for each period and tree
layout (matrix (1:4, ncol = 2, byrow = TRUE))
par (mar = c (5,5,1,1))
plot (x = as_date (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] == '01M']),
      y = data [['CWTALL']] [data [['YEAR']] == 2017 & data [['TREE']] == '01M'],
      las = 1, col = 'white', typ = 'l',
      ylab = 'cell wall thickness (microns)',
      xlab = 'estimated time of formation',
      xlim = as_date (c ('2017-03-01','2017-11-30')),
      ylim = c (1.4, 5))
# draw sampling dates
abline (v = as_date (c ('2017-07-03','2017-08-09','2017-10-09','2017-11-03')), col = '#99999999', lwd = 2)
# plot all control trees
treeLabels <- c ('01M','03M','04M','06M','07M','09M','18M','30M','31M','36M')
controlMean <- aggregate (x  = data [['CWTALL']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                          by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                          mean)
lines (x = as_date (controlMean [, 1]),
       y = rollmean (controlMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [1], lwd = 2)
#plotEndOfGrowingSeason (y = 2.3, treeLabels = treeLabels, colour = colours [1], symbol = 19)
# above the girld 
treeLabels <- c ('05A','11A','15A','16A','19A','23A','29A','35A','39A','40A')
aboveGirdlMean <- aggregate (x  = data [['CWTALL']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                             by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                             mean)
lines (x = as_date (aboveGirdlMean [, 1]),
       y = rollmean (aboveGirdlMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [2], lwd = 2)
#plotEndOfGrowingSeason (y = 2.1, treeLabels = treeLabels, colour = colours [2], symbol = 19)
# below the girdl 
treeLabels <- c ('05B','11B','15B','16B','19B','23B','29B','35B','39B','40B')
belowGirdlMean <- aggregate (x  = data [['CWTALL']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                             by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                             mean)
lines (x = as_date (belowGirdlMean [, 1]),
       y = rollmean (belowGirdlMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [2], lwd = 2, lty = 2)
#plotEndOfGrowingSeason (y = 2.05, treeLabels = treeLabels, colour = colours [2], symbol = 21)
# above the compression
treeLabels <- c ('10A','12A','13A','17A','20A','21A','28A','32A','33A','38A')
aboveComprMean <- aggregate (x  = data [['CWTALL']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                             by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                             mean)
lines (x = as_date (aboveComprMean [, 1]),
       y = rollmean (aboveComprMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [3], lwd = 2)
#plotEndOfGrowingSeason (y = 1.90, treeLabels = treeLabels, colour = colours [3], symbol = 19)
# below the compression
treeLabels <- c ('10B','12B','13B','17B','20B','21B','28B','32B','33B','38B')
belowComprMean <- aggregate (x  = data [['CWTALL']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                             by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                             mean)
lines (x = as_date (belowComprMean [, 1]),
       y = rollmean (belowComprMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [3], lwd = 2, lty = 2)
#plotEndOfGrowingSeason (y = 1.80, treeLabels = treeLabels, colour = colours [3], symbol = 21)
# above the double compression
treeLabels <- c ('02A','08A','14A','22A','24A','25A','26A','27A','34A','37A')
aboveDCompMean <- aggregate (x  = data [['CWTALL']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                              by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                              mean)
lines (x = as_date (aboveDCompMean [, 1]),
       y = rollmean (aboveDCompMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [4], lwd = 2)
#plotEndOfGrowingSeason (y = 1.60, treeLabels = treeLabels, colour = colours [4], symbol = 19)
# between the double compression
treeLabels <- c ('02M','08M','14M','22M','24M','25M','26M','27M','34M','37M')
betweenDCompMean <- aggregate (x  = data [['CWTALL']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                               by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                               mean)
lines (x = as_date (betweenDCompMean [, 1]),
       y = rollmean (betweenDCompMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [4], lwd = 2, lty = 3)
#plotEndOfGrowingSeason (y = 1.5, treeLabels = treeLabels, colour = colours [4], symbol = 22)
# below the double compression
treeLabels <- c ('02B','08B','14B','22B','24B','25B','26B','27B','34B','37B')
belowDCompMean <- aggregate (x  = data [['CWTALL']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                             by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                             mean)
#plotEndOfGrowingSeason (y = 1.4, treeLabels = treeLabels, colour = colours [4], symbol = 21)
lines (x = as_date (belowDCompMean [, 1]),
       y = rollmean (belowDCompMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [4], lwd = 2, lty = 2)

# plot cell size of the 2017 ring for each period and tree
plot (x = as_date (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] == '01M']),
      y = data [['DRAD']] [data [['YEAR']] == 2017 & data [['TREE']] == '01M'],
      las = 1, col = 'white', typ = 'l',
      ylab = 'lumen diameter (microns)',
      xlab = 'estimated time of formation',
      xlim = as_date (c ('2017-03-01','2017-11-03')),
      ylim = c (5, 50))
# draw sampling dates
abline (v = as_date (c ('2017-07-03','2017-08-09','2017-10-09','2017-11-03')), col = '#99999999', lwd = 2)
# plot all control trees
treeLabels <- c ('01M','03M','04M','06M','07M','09M','18M','30M','31M','36M')
controlMean <- aggregate (x  = data [['cellRadWidth']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                          by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                          mean)
lines (x = as_date (controlMean [, 1]),
       y = rollmean (controlMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [1], lwd = 2)
# above the girld 
treeLabels <- c ('05A','11A','15A','16A','19A','23A','29A','35A','39A','40A')
aboveGirdlMean <- aggregate (x  = data [['cellRadWidth']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                             by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                             mean)
lines (x = as_date (aboveGirdlMean [, 1]),
       y = rollmean (aboveGirdlMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [2], lwd = 2)
# below the girld 
treeLabels <- c ('05B','11B','15B','16B','19B','23B','29B','35B','39B','40B')
belowGirdlMean <- aggregate (x  = data [['cellRadWidth']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                             by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                             mean)
lines (x = as_date (belowGirdlMean [, 1]),
       y = rollmean (belowGirdlMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [2], lwd = 2, lty = 2)
# above the compression
treeLabels <- c ('10A','12A','13A','17A','20A','21A','28A','32A','33A','38A')
aboveComprMean <- aggregate (x  = data [['cellRadWidth']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                             by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                             mean)
lines (x = as_date (aboveComprMean [, 1]),
       y = rollmean (aboveComprMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [3], lwd = 2)
# below the compression
treeLabels <- c ('10B','12B','13B','17B','20B','21B','28B','32B','33B','38B')
belowComprMean <- aggregate (x  = data [['cellRadWidth']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                             by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                             mean)
lines (x = as_date (belowComprMean [, 1]),
       y = rollmean (belowComprMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [3], lwd = 2, lty = 2)
# above the doublecompression
treeLabels <- c ('02A','08A','14A','22A','24A','25A','26A','27A','34A','37A')
aboveDCompMean <- aggregate (x  = data [['cellRadWidth']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                              by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                              mean)
lines (x = as_date (aboveDCompMean [, 1]),
       y = rollmean (aboveDCompMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [4], lwd = 2)
# between the double compression
treeLabels <- c ('02M','08M','14M','22M','24M','25M','26M','27M','34M','37M')
betweenDCompMean <- aggregate (x  = data [['cellRadWidth']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                               by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                               mean)
lines (x = as_date (betweenDCompMean [, 1]),
       y = rollmean (betweenDCompMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [4], lwd = 2, lty = 3)
# below the double compression
treeLabels <- c ('02B','08B','14B','22B','24B','25B','26B','27B','34B','37B')
belowDCompMean <- aggregate (x  = data [['cellRadWidth']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                              by = list (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                              mean)
lines (x = as_date (belowDCompMean [, 1]),
       y = rollmean (belowDCompMean [, 2], window, na.pad = TRUE, na.rm = T),
       col = colours [4], lwd = 2, lty = 2)
legend (x = as_date ('2017-04-25'), lty = c (0, rep (1, 3)), lwd = 2,
        y = 28, box.lty = 0, bg = 'transparent', col = colours, legend = c ('control','girdled','compressed','double compression'))
legend (x = as_date ('2017-03-01'), lty = c (0, rep (2, 3)), lwd = 2,
        y = 28, box.lty = 0, bg = 'transparent', col = colours, legend = c ('','','',''))
legend (x = as_date ('2017-03-30'), lty = c (1, 0, 0, 3), lwd = 2,
        y = 28, box.lty = 0, bg = 'transparent', col = colours, legend = c ('','','',''))
text (x = as_date (c ('2017-03-15','2017-04-15','2017-05-15')), 
      y = 28, labels = c ('below','middle', 'above'), cex = 0.9)

# create tibble with cell numbers per ring
cellNumber <- tibble (tree = NA, treatment = NA, height = NA, n = NA)

# determine the approximate number of cells in each ring
for (iTree in 1:40) { # loop over trees
  
  # get treatment and determine heights
  if (unique (data [['PLOT']] [as.numeric (substr (data [['TREE']], 1, 2)) == iTree]) == 'T1') {
    heights <-  c ('M')
    treatment <- 1
  } else if (unique (data [['PLOT']] [as.numeric (substr (data [['TREE']], 1, 2)) == iTree]) == 'T2') {
    heights <-  c ('A', 'B')
    treatment <- 2
  } else if (unique (data [['PLOT']] [as.numeric (substr (data [['TREE']], 1, 2)) == iTree]) == 'T3') {
    heights <-  c ('A', 'B')
    treatment <- 3
  } else if (unique (data [['PLOT']] [as.numeric (substr (data [['TREE']], 1, 2)) == iTree]) == 'T4') {
    heights <-  c ('A', 'M', 'B')
    treatment <- 4
  }
  
  # loop over sampling heights
  for (iHeight in heights) {
    
    if (iTree < 10) {
      treeID <- paste0 ('0',iTree,iHeight)
    } else {
      treeID <- paste0 (iTree, iHeight)
    }
    
    # determine average number of cells in sector and sum them
    condition <- data [['YEAR']] == 2017 & data [['TREE']] == treeID
    nCells <- floor (sum (20 / data [['cellRadWidth']] [condition], na.rm = TRUE))
    iH <- iHeight
    if (treatment == 1) iH <- 'C'
    cellNumber <- add_row (cellNumber, tree = iTree, treatment = treatment, height = iH, n = nCells)
      
  } # end height loop
} # end tree loop

# delete first row, which is empty and 06.1M because data is no good
cellNumber <- cellNumber [-1, ]
#cellNumber [['n']] [cellNumber [['tree']] == 6] <- NA 

# mean and standard deviation of cell number by treatment and height 
cellNMeans <- aggregate (cellNumber [['n']], by = c (list (cellNumber [['height']]), list (cellNumber [['treatment']])), FUN = mean)
cellNSD  <- aggregate (cellNumber [['n']], by = c (list (cellNumber [['height']]), list (cellNumber [['treatment']])), FUN = sd)

# plot box plot of the estimated end time of growth in each treatment
xPositions <- c (0.8, 1.8, 2.3, 3.3, 3.8, 4.8, 5.3, 5.8)

# determine the last day of growth for control trees

par (mar = c (5,5,1,1))
treeLabels <- c ('01M','03M','04M','06M','07M','09M','18M','30M','31M','36M')
lastDates <- aggregate (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                        by = list (data [['TREE']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                        max, na.rm = TRUE)
lastDates [is.infinite (lastDates [, 2]), 2] <- NA
# boxplot of control trees
boxplot (at = xPositions [1],
         x = as_date (lastDates [[2]]), xlab = 'estimated end of growth', ylab = 'treatment and sampling height', horizontal = TRUE,
         col = colours [1], las = 1, 
         xlim = c (0, 6), ylim = as_date (c ('2017-03-01','2017-11-15')), 
         lty = 1, pars = list (outbg = colours [1], outpch = 21))

# determine the last day of growth for below the girdl
treeLabels <- c ('05B','11B','15B','16B','19B','23B','29B','35B','39B','40B')
lastDates <- aggregate (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                        by = list (data [['TREE']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                        max, na.rm = TRUE)
lastDates [is.infinite (lastDates [, 2]), 2] <- NA
# boxplot for below the girdl
boxplot (at = xPositions [2],
         x = as_date (lastDates [[2]]), xlab = '', ylab = '', horizontal = TRUE, axes = FALSE, add = TRUE,
         border = colours [2], col = 'white', 
         lty = 1)
# determine the last day of growth for above the girdl
treeLabels <- c ('05A','11A','15A','16A','19A','23A','29A','35A','39A','40A')
lastDates <- aggregate (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                        by = list (data [['TREE']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                        max, na.rm = TRUE)
lastDates [is.infinite (lastDates [, 2]), 2] <- NA
# boxplot above the girdl
boxplot (at = xPositions [3],
         x = as_date (lastDates [[2]]), xlab = '', ylab = '', horizontal = TRUE,axes = FALSE, add = TRUE,
         col = colours [2],  
         lty = 1, pars = list (outbg = colours [2], outpch = 21))
axis (side = 2, at = xPositions, 
      labels = c ('1 M','2 B','2 A','3 B','3 A','4 B','4 M','4 A'), 
      tick = 1, las = 1)

# determine the last day of growth for below the compression
treeLabels <- c ('10B','12B','13B','17B','20B','21B','28B','32B','33B','38B')
lastDates <- aggregate (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                        by = list (data [['TREE']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                        max, na.rm = TRUE)
lastDates [is.infinite (lastDates [, 2]), 2] <- NA
# boxplot for below the compression
boxplot (at = xPositions [4],
         x = as_date (lastDates [[2]]), xlab = '', ylab = '', horizontal = TRUE, axes = FALSE, add = TRUE,
         border = colours [3], col = 'white', 
         lty = 1)
# determine the last day of growth for above the compression
treeLabels <- c ('10A','12A','13A','17A','20A','21A','28A','32A','33A','38A')
lastDates <- aggregate (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                        by = list (data [['TREE']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                        max, na.rm = TRUE)
lastDates [is.infinite (lastDates [, 2]), 2] <- NA
# boxplot above the compression
boxplot (at = xPositions [5],
         x = as_date (lastDates [[2]]), xlab = '', ylab = '', horizontal = TRUE,axes = FALSE, add = TRUE,
         col = colours [3],  
         lty = 1, pars = list (outbg = colours [3], outpch = 21))
# determine the last day of growth for below the double compression
treeLabels <- c ('02B','08B','14B','22B','24B','25B','26B','27B','34B','37B')
lastDates <- aggregate (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                        by = list (data [['TREE']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                        max, na.rm = TRUE)
lastDates [is.infinite (lastDates [, 2]), 2] <- NA
# boxplot for below the double compression
boxplot (at = xPositions [6],
         x = as_date (lastDates [[2]]), xlab = '', ylab = '', horizontal = TRUE, axes = FALSE, add = TRUE,
         border = colours [4], col = 'white', 
         lty = 1)
# determine the last day of growth for below the double compression
treeLabels <- c ('02M','08M','14M','22M','24M','25M','26M','27M','34M','37M')
lastDates <- aggregate (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                        by = list (data [['TREE']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                        max, na.rm = TRUE)
lastDates [is.infinite (lastDates [, 2]), 2] <- NA
# boxplot for below the double compression
boxplot (at = xPositions [7],
         x = as_date (lastDates [[2]]), xlab = '', ylab = '', horizontal = TRUE, axes = FALSE, add = TRUE,
         border = colours [4], col = '#666666', 
         lty = 1)
# determine the last day of growth for above the double compression
treeLabels <- c ('02A','08A','14A','22A','24A','25A','26A','27A','34A','37A')
lastDates <- aggregate (data [['formationDate']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels], 
                        by = list (data [['TREE']] [data [['YEAR']] == 2017 & data [['TREE']] %in% treeLabels]), 
                        max, na.rm = TRUE)
lastDates [is.infinite (lastDates [, 2]), 2] <- NA
# boxplot above the double compression
boxplot (at = xPositions [8],
         x = as_date (lastDates [[2]]), xlab = '', ylab = '', horizontal = TRUE,axes = FALSE, add = TRUE,
         col = colours [4],  
         lty = 1, pars = list (outbg = colours [4], outpch = 21))

axis (side = 2, at = xPositions, 
      labels = c ('1 M','2 B','2 A','3 B','3 A','4 B','4 M','4 A'), 
      tick = 1, las = 1)


# plot box plot of number of cell per ring in each treatment
par (mar = c (5,5,1,1))
xPositions <- c (0.8, 1.8, 2.3, 3.3, 3.8, 4.8, 5.3, 5.8)
boxplot (at = xPositions [1], x = cellNumber [['n']] [cellNumber [['treatment']] == 1],
         col = colours [1], xlab = 'number of cells', ylab = '', las = 1, yax = 'n',
         xlim = c (0, tail(xPositions, n = 1)+head(xPositions, n = 1)), ylim = c (0, 100), horizontal = TRUE, lty = 1)
boxplot (at = xPositions [2], x = cellNumber [['n']] [cellNumber [['treatment']] == 2 & cellNumber [['height']] == 'B'],
         border = colours [2], bg = 'white', add = TRUE, axes = FALSE, horizontal = TRUE, lty = 1)
boxplot (at = xPositions [3], x = cellNumber [['n']] [cellNumber [['treatment']] == 2 & cellNumber [['height']] == 'A'],
         col = colours [2], add = TRUE, axes = FALSE, horizontal = TRUE, lty = 1)
boxplot (at = xPositions [4], x = cellNumber [['n']] [cellNumber [['treatment']] == 3 & cellNumber [['height']] == 'B'],
         border = colours [3], bg = 'white', add = TRUE, axes = FALSE, horizontal = TRUE, lty = 1)
boxplot (at = xPositions [5], x = cellNumber [['n']] [cellNumber [['treatment']] == 3 & cellNumber [['height']] == 'A'],
         col = colours [3], add = TRUE, axes = FALSE, horizontal = TRUE, pars = list (outbg = colours [3], outpch = 21), lty = 1)
boxplot (at = xPositions [6], x = cellNumber [['n']] [cellNumber [['treatment']] == 4 & cellNumber [['height']] == 'B'],
         border = colours [4], bg = 'white', add = TRUE, axes = FALSE, horizontal = TRUE, lty = 1)
boxplot (at = xPositions [7], x = cellNumber [['n']] [cellNumber [['treatment']] == 4 & cellNumber [['height']] == 'M'],
         border = colours [4], col = '#666666', add = TRUE, axes = FALSE, horizontal = TRUE, lty = 1)
boxplot (at = xPositions [8], x = cellNumber [['n']] [cellNumber [['treatment']] == 4 & cellNumber [['height']] == 'A'],
         col = colours [4], add = TRUE, axes = FALSE, horizontal = TRUE, pars = list (outbg = colours [4], outpch = 21), lty = 1)
```


# References