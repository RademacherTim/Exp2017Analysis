---
title: "SI - structural carbon gain"
author: Tim Rademacher
date: "16/08/2019"
output: html_document
bibliography: "/home/trademacehr/projects/NSF-DB\ Plant\ Growth/bib/Exp2017.bib"
csl: "/home/trademacehr/projects/NSF-DB\ Plant\ Growth/bib/harvard.csl"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library ('RAPTOR')
library ('zoo')
library ('plyr')
library ('readxl')
library ('tidyverse')
```

## Structural carbon gain for stem sections of the 2017 experiment at Harvard Forest

Tghe estimation of structural carbon gain for each stem section is based on the determination of cell wall area of one (or two, when available) thinsection images sampled at the end of the growing season (1$^{st}$ of November 2017). The images were analysed using ROXAS [@von_arx_roxas_2014] and outputs are processed below using the RAPTOR [@peters_raptor:_2018] in R [@r_core_team_r:_2019]. 

``` {r readinputFiles}
# Source the read.roxas function 
source ('../data/HF_2017_T1_T4_Rox/Functions/1-read.roxas.R')
source ('../data/HF_2017_T1_T4_Rox/Functions/2-assign.to.R')

# Read in all ROXAS outputs
suppressMessages (T2017 <- read.roxas (WD = '../data/HF_2017_T1_T4_Rox/', 
                                       from = 1998, to = 2018,
                                       PLOT = FALSE))

# Extract ring specific data and add treatment and ID columns
ringData <- T2017 [['ring']]
ringData [['Treatment']] <- as.numeric (substr (ringData [['TREE.ID']], 2, 2)) 
ringData [['TREE.ID']]   <- as.numeric (substr (ringData [['TREE.ID']], 4, 5)) 
ringData [['year']]      <- as.numeric (ringData [['YEAR']])

# Correction because the last ring in T3 and T4 was incorrectly dated
condition <- which (ringData [['Treatment']] == 3 | 
                    ringData [['Treatment']] == 4)
ringData [['year']] [condition] <- as.numeric (ringData [['YEAR']] [condition]) + 1

# Sum the cell wall area for each ring
ringSummary <- ringData %>%  
               mutate (CWA = replace (CWA, CWA == -999,  NA)) %>%
               mutate (CWA = replace (CWA, CWA == -9999, NA)) %>%
               group_by (SITE, TREE.ID, year, Treatment) %>%
               dplyr::summarise (CWAsum = sum (CWA, na.rm = T), 
                                 LDradmean  = mean (LDrad,  na.rm = TRUE), 
                                 CWTradmean = mean (CWTrad, na.rm = TRUE)) 
```

We first determined the sum of cell wall area and ring width of each annual ring formed in the growing seasons from 2015<!--TR I could actually try to go back further in time to try to see what is the oldest ring I can get.--> to 2017. This total annual cell wall area incerement is further divided into the increments during four distinct periods of (i) pre-treatment, (ii) the first month after the start of the treatment, (iii) second and third month after the start of the treatment and (iv) the remainder of the growing season. For this purpose, we first estimating the fraction of the ring width that has formed in each period ($RW_{p,s}$) from the thinsections taken at the beginning of each period and on the 1$st$ of November 2017 and standardise it for local variations in radial growth by division with the ring width of the 2015 ring ($RW_{2015}$).

```{r}
# Extract only 2015 to 2017
ringSummary <- ringSummary %>% filter(year >= 2015)
```

$$
f_{p,s} = \frac {RW_{p,s}} {RW_{2017,s}} \times \frac {1} {RW_{2015,s}}
$$

We did use the 2016 ring because a severe drought in 2016 caused intra-annual density fluctuations in vigorous trees but narrower rings in less vigorous trees. These systematic variations in the 2016 ring width would introduce a systematic bias. Consequently, 2015 was used to correct for local variations in ring width, as it was the youngest year typical growth. In fact, 2015 had similar climatic conditions to 2017. <!-- TR need to double the claim that 2015 and 2017 had similar climate conditions.-->
<!-- Maybe I should rather use the oldest available ring or at least not a drought year ring (such as 2016, 2012, 2011, 2013)--> 

The fractional ring width was subsequently used to estimate the cell wall area formed in each period. For this purpose, we used the RAPTOR package to divide the final ring into 100 sectors. Each sector was associated with one of the four period, using the fractional ring width as boundaries. Sectors that were split by a period boundary, where fractionally added to both adjacent period.

```{r}
# Divide each ring into 100 sectors for calculation percent annual structural carbon gain
cellularData <- assign.to (T2017 [['cell']], method = "SECTOR", NSECTOR = 100)

# Add treatment and treeID to the cell and ring data
cellularData [['Treatment']] <- as.numeric (substr (cellularData [['TREE.ID']], 2, 2))
cellularData [['TREE.ID']]   <- as.numeric (substr (cellularData [['TREE.ID']], 4, 5))
cellularData [['CWA']]       <- as.numeric (cellularData [['CWA']])


# Correction because the last ring in T3 and T4 was incorrectly dated
condition <- which (cellularData [['Treatment']] == 3 | 
                    cellularData [['Treatment']] == 4)
cellularData [['YEAR']] [condition] <- cellularData [['YEAR']] [condition] + 1
  
# Sum the cell wall area for each sector
  

# A<-T2017TO %>% 
#   filter(YEAR>=2015, CWTrad!=-9999, CWTrad!=-999, !is.na(TO.SECTORS)) %>%
# mutate(CWTrad=replace(CWTrad, CWTrad==-999, NA)) %>% 
#  mutate(CWTrad=replace(CWTrad, is.nan(CWTrad), NA)) %>% 
#  group_by(SITE,TREE.ID,as.factor(YEAR),Treatment,TO.SECTORS)
```

The cell wall area increment is scaled geometrically to the stem section's cell wall volume increment in two steps, assuming that wood formed homogenously around the stem in each section and the above estimate is representative of the formed wood for each section and period. Using the stem section's circumference, as measured at the beginning of the experiment ($CBH_{outer, s}$). First, the circumference is reduce assuming a bark thickness of 0.8 $cm$ according to the following equation:

$$
CBH_{s} = CBH_{outer, s} - 0.8 \, cm \times 2 \pi 
$$

Second, the reduced stem section circumference is divided by the radial width of the thinsection ($w_{r,s}$) and multiplied by the cell wall area increment () and the stem section height (here $h = 0.1\,m$) to estimate the total volume of newly formed cell wall in each section and period ($V_{CW,s}$). 
$$
V_{CW,s,p} =  \frac {CBH_{s}} {w_{r,s}} \times h_{s}
$$
Finally, the cell wall volume of each section is multiplied with a cell wall density ($\rho_{CW}$) of $1.489$ $kg \, m^3$ - a best estimate based on data for comparable softwoods, such as Scots pine, by @plotze_porosity_2011 - and an assumed carbon content of 49.74\% for white pine [@lamlom_reassessment_2003] to estimate the total structural carbon gain per stem section and period ($M_{p,s}$ in $g$).

$$
M_{s,p} = V_{CW,s,p} \times \rho_{CW} \times 0.5
$$
<!--
## Alternative simple increment estimations

Assuming a density is constant and simply multiplying it with the radial increment, we can get a simple estimation of the biomass accrued in each period. 

## Comparison of detailed and simple estimations

Compare the simple and more complex method.

### To-do list and comments

- check whether results are robust even with assumed realistic taper of the stem section. I will have to measure the section circumferences and taper first.
- cell wall density and carbon content are known to vary with season [@lamlom_reassessment_2003], check robustness of results with realistic variation.-->

# References