---
title: 'Scaling structural carbon (SI 2)'
author: Tim Rademacher
date: "01/11/2019"
output: html_document
bibliography: "/home/trademacehr/projects/PlantGrowth/bib/Exp2017.bib"
csl: "/home/trademacehr/projects/PlantGrowth/bib/harvard.csl"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library ('plyr')
library ('knitr')
library ('tidyverse')
library ('readxl')
library ('googledrive')
library ('rjson')

# set colour scheme for control, girdled, compressed, double compressed and chilled
colours <- c ('#91b9a4','#ea7125','#8f2bbc','#d6083b','#0072cf')
```

## Structural carbon estimation for stem sections of the 2017 experiment at Harvard Forest

``` {r getData, echo = FALSE}
# Get list of folder on shared PlantGrowth google drive
GDFolders  <- drive_ls (path = 'https://drive.google.com/drive/u/1/folders/0ABA0-TtlzSLPUk9PVA')

# Get id for data folder on shared PlantGrowth google drive
GDDataID <- GDFolders [['id']] [GDFolders [['name']] == 'data']

# Get list of folders in data folder
GDFoldersData <- drive_ls (path = as_id (GDDataID))

# Get microcores folder id
GDmicrocoresID <- GDFoldersData [['id']] [GDFoldersData [['name']] == 'microcores']

# Get list of folders in micrcores folder
GDFoldersMicrocores <- drive_ls (path = as_id (GDmicrocoresID))

# Get woodAnatomy folder id
GDwoodAnatomyID <- GDFoldersMicrocores [['id']] [GDFoldersMicrocores [['name']] == 'woodAnatomy']

# Get list of folders in woodAnatomy folder
GDFoldersWoodAnatomy <- drive_ls (path = as_id (GDwoodAnatomyID))

# Get Exp2017 folder id
GDExp2017ID <- GDFoldersWoodAnatomy [['id']] [GDFoldersWoodAnatomy [['name']] == 'Exp2017']

# Get list of files in Exp2017 folder
GDFilesExp2017 <- drive_ls (path = as_id (GDExp2017ID))

# Get id of file with data for 20 mu band anatomical averages
GDExp2017FileID <- GDFilesExp2017 [['id']] [GDFilesExp2017 [['name']] == '20muband_ALL.xlsx']

# Get id of folder with ring width measurements from TRIAD
GDFolderringWidthTRIADID <- GDFilesExp2017 [['id']] [GDFilesExp2017 [['name']] == 'ringWidthTRIAD']

# Get list of ids for all ringwidth measurements
GDringWidthFilesIDs <- drive_ls (path = as_id (GDFolderringWidthTRIADID))

# Identify allometry folder
GDallometryID <- GDFoldersData [['id']] [GDFoldersData [['name']] == 'allometry']

# List files in allometry folder
GDFilesAllometry <- drive_ls (path = as_id (GDallometryID))

# Identify id of file with allometry data for the 2017 Experiment
GDExp2017AllometryFileID <- GDFilesAllometry [['id']] [GDFilesAllometry [['name']] == 'allometricDataExp2017.xlsx']

# Change working directory
setwd ('/media/TREE/PlantGrowth/data/microcores/woodAnatomy/Exp2017/')

# Download the Exp2017 wood anatomical data file
# fileExp2017 <- drive_download (file = as_id (GDExp2017FileID), verbose = FALSE, overwrite = TRUE)
# rm (fileExp2017)

# Read the data per 20 micron slices
data <- read_excel (path = paste0 (getwd (),'/20muband_ALL.xlsx'), 
                    sheet = '20muband_ALL', 
                    na = "NA")

# Change working directory
setwd ('/media/TREE/PlantGrowth/data/microcores/woodAnatomy/Exp2017/ringWidthTRIAD/')

# Download the files for ring width measurements of the Exp 2017 microcores
# for (i in 1:dim (GDringWidthFilesIDs) [1]) {
#   fileExp2017 <- drive_download (file = as_id (GDringWidthFilesIDs [['id']] [i]), verbose = FALSE, overwrite = TRUE)
#   rm (fileExp2017)
#   print (i)
# }

# Change working directory
setwd ('/media/TREE/PlantGrowth/data/allometry/')

# Download the Exp2017 allometry data file
# fileExp2017 <- drive_download (file = as_id (GDExp2017AllometryFileID), verbose = FALSE, overwrite = TRUE)
# rm (fileExp2017)

# Read the data per 20 micron slices
allometricData <- read_excel (path = paste0 (getwd (),'/allometricDataExp2017.xlsx'), 
                              sheet = 'allometricData', 
                              na = "NA")

# Reset the working directory
setwd ('/home/trademacehr/projects/PlantGrowth/Exp2017/Exp2017Analysis/')
```

The estimation of structural carbon gain for each stem section is scaled from the cell wall area of one thinsection sampled at the end of the growing season (3$^{rd}$ of November 2017) and divided into sections grown in each period (e.g., prior, during and after treatment) by association with the proporation of the ring formed at the end of that period. Where the first thinsection did not fully include the necessary rings or had other quality issues, we cut and processed the second microcore for a thinsection. Between the two microcores, we were able to obtain high-quality image data for 314<!-- TR - Image 06.1 M for 2017/08/09 only contains part of the 2017 ring. And images 06.1 M, 24.4 A and 24.4 B are missing the 2015 ring. There must be two additional rings missing because the numbferOfSamples suggests so!!!--> out of 320 samples (i.e., 4 dates times 40 trees times on average two sampling heights per tree). Only for one tree (tree id: 06; treament: control) both samples collected in October for the middle section did not contain a full 2015 ring. For each image, we identified and divided the ring formed in 2017 into 20 micron-wide discrete zones and derived the average anatomical structure for a cell in each zone using ROXAS [@von_arx_roxas_2014]. In particular, we measured cell wall area, cell wall thickness, and tangential and radial cell width. The ring width of the fully formed ring ranged between `r range (unique (data [['MRW']] [data [['YEAR']] == 2017])) [1]/1000` and `r range (unique (data [['MRW']] [data [['YEAR']] == 2017])) [2] / 1000`mm with a mean of `r mean (unique (data [['MRW']] [data [['YEAR']] == 2017]))/1000`mm. Using 20 micron-wide zones, the rings were divided into, at least, `r round (range (unique (data [['MRW']] [data [['YEAR']] == 2017])) [1]/20)` sections.

## Dividing cell wall area by period of formation

We also identified the 2017 and 2015 ring and measured their width in images taken prior (e.g., 3$^{rd}$ of July 2017) and during the treatment (e.g., 10$^{th}$ of August 2017, and 9$^{th}$ of October 2017), as well as at the end of the growing season (3$^{rd}$ of November). All ring width measurements were performed with the Tree Ring Image Analysis and Database (TRIAD). The accuracy of TRIAD is limited by the resolution of the uploaded images; here roughly 1.5 microns. The relative ring width of the 2017 ring in comparison to the 2015 ring was used to estimate the proportion of the ring formed at th end of each period. As growth varies locally around the circumference of the stem, we tried to account for local circumferential variations in growth by standardisation with the 2015 ring width from the same image as follows: 

$$
f_{2017,i} = \frac {rw_{2017,i} \times rw_{2015,Nov}} {rw_{2015,i}} \times \frac{1} {rw_{2017,Nov}}
$$
, where $rw_{2015,Nov}$ and $rw_{2015,Nov}$ are respectively the 2015 and 2017 ring widths as measured at the end of the growing season in November 2017. This assumes that the ring was fully formed on the 1$^{st}$ of November, which is about two weeks after the typical end of cell wall thickening for white pine at Harvard Forest. Then, $f_{2017,i}$ theoretically varies between 0 and 1 with 0 meaning non of the ring was formed at the sampling date and 1 meaning that the entire ring was already formed.

```{r climateData, echo = FALSE}
metData <- read_csv (url ('https://harvardforest.fas.harvard.edu/data/p30/hf300/hf300-01-annual-m.csv'), 
                     col_types = cols ())
```

The number of measurements for growth rings drops off strongly after the 2015 growth ring (table 1), because the older the ring the less likely it is to be covered by the 15mm microcore, hence visible in the thinsection image. Due to this drop, we wanted to use a recent year to adjust for local growth difference. 2015 was preferred over 2016, because an abnormally dry growing season in 2016 (total annual precipitation of `r metData [['prec']] [metData [['year']] == 2016]` $mm$, which is `r round (mean (metData [['prec']]) - metData [['prec']] [metData [['year']] == 2016])` below the long-term average of `r round (mean (metData [['prec']]))` $mm$). In contrast the 2015 growing season climate was similar to the 2017 growing season climate with a mean annual temperature of `r metData [['airt']] [metData [['year']] == 2015]` $^{\circ}C$ and a total annual precipitation of `r metData [['prec']] [metData [['year']] == 2015]` $mm$. In fact, about three quraters of trees included in this study showed a intra-annual density fluctuation in 2016 due to the dry growing season and the remaining quarter of trees had a relatively narrower ring. Consequently, standardisation by the 2016 ring would introduce a systematic bias based on the bi-modal ring width distribution in 2016. In contrast, 2015 did not include any outstading climatological events, which led to systematic bias in growth as observed in 2016.

``` {r getRingWidths, echo = FALSE}
# build data frame with ring width measurements for each of the four thinsections
ringWidths <- tibble (tree = rep (1:40, 4),
                      treatment = rep (allometricData [['treatment']] [1:40], 4),
                      month = c (rep (7, 40), rep (8, 40), rep (10, 40), rep (11, 40)),
                      RW2017at250 = NA, RW2017at200 = NA, RW2017at150 = NA, RW2017at100 = NA, RW2017at050 = NA,
                      RW2016at250 = NA, RW2016at200 = NA, RW2016at150 = NA, RW2016at100 = NA, RW2016at050 = NA,
                      RW2015at250 = NA, RW2015at200 = NA, RW2015at150 = NA, RW2015at100 = NA, RW2015at050 = NA,
                      RW2014at250 = NA, RW2014at200 = NA, RW2014at150 = NA, RW2014at100 = NA, RW2014at050 = NA,
                      RW2013at250 = NA, RW2013at200 = NA, RW2013at150 = NA, RW2013at100 = NA, RW2013at050 = NA,
                      RW2012at250 = NA, RW2012at200 = NA, RW2012at150 = NA, RW2012at100 = NA, RW2012at050 = NA,
                      RW2011at250 = NA, RW2011at200 = NA, RW2011at150 = NA, RW2011at100 = NA, RW2011at050 = NA,
                      RW2010at250 = NA, RW2010at200 = NA, RW2010at150 = NA, RW2010at100 = NA, RW2010at050 = NA,
                      RW2009at250 = NA, RW2009at200 = NA, RW2009at150 = NA, RW2009at100 = NA, RW2009at050 = NA,
                      RW2008at250 = NA, RW2008at200 = NA, RW2008at150 = NA, RW2008at100 = NA, RW2008at050 = NA)


# set working directory to read json files
setwd ('/media/TREE/PlantGrowth/data/microcores/woodAnatomy/Exp2017/ringWidthTRIAD/')

# list all json output file from TRIAD
jsonFiles <- list.files (path = './', pattern = '.json')

# set loop variable to count files with 2018 year growth
k <- 0

# loop over json files and read them
for (j in 1: length (jsonFiles)) {
  
  # read in TRIAD outputs
  temp <- fromJSON (file = jsonFiles [j]) 
  treeID <- as.numeric (substr (temp [['sampleID']], 1, 2))
  sampleDate <- lubridate::month (temp [['sampleDate']])
  len <- length (temp [['growth']])
  # print (c (j, treeID, sampleDate))
  for (i in 1:len) {
    if (i  == 1) {
      types  <- unlist (temp [['growth']] [i]) [6]
      years  <- unlist (temp [['growth']] [i]) [7] 
      growth <- unlist (temp [['growth']] [i]) [9]
    } else {
      types  <- c (types,  unlist (temp [['growth']] [i]) [6])
      years  <- c (years,  unlist (temp [['growth']] [i]) [7])
      growth <- c (growth, unlist (temp [['growth']] [i]) [9])
    }
  }
  if (max (years) == 2017 & growth [years == '2017' & types == 'Normal'] == '0') {
    print (paste0 ('Error with the year number 2017 for:', jsonFiles [j]))
  } else if (max (years) >= 2017 & growth [years == '2018' & types == 'Normal'] != '0') {
    k <- k + 1
    print (paste0 (jsonFiles [j],' has a 2018, CHECK IT!!!', max (years),' file number ', k))
  }
  growth <- as.numeric (growth [types == 'Normal' & years <= 2017])
  years  <- as.numeric (years  [types == 'Normal' & years <= 2017])
  growth <- c (growth, rep (NA, 10-length (growth)))
  years  <- c (years,  seq (years [length (years)]-1, 2008))
      
  t <- as.numeric (substr (temp [['sampleID']], 4, 4))
  if (t == 1) {
    if (!is.na (growth [years == 2017])) {
      ringWidths [['RW2017at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2017]
    }
    if (!is.na (growth [years == 2016])) {
      ringWidths [['RW2016at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2016]
    }
    if (!is.na (growth [years == 2015])) {
      ringWidths [['RW2015at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2015]
    }
    if (!is.na (growth [years == 2014])) {
      ringWidths [['RW2014at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2014]
    }
    if (!is.na (growth [years == 2013])) {
      ringWidths [['RW2013at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2013]
    }
    if (!is.na (growth [years == 2012])) {
      ringWidths [['RW2012at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2012]
    }
    if (!is.na (growth [years == 2011])) {
      ringWidths [['RW2011at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2011]
    }
    if (!is.na (growth [years == 2010])) {
      ringWidths [['RW2010at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2010]
    }
    if (!is.na (growth [years == 2009])) {
      ringWidths [['RW2009at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2009]
    }
    if (!is.na (growth [years == 2008])) {
      ringWidths [['RW2008at150']] [ringWidths [['tree']] == treeID & 
                                    ringWidths [['month']] == sampleDate] <- growth [years == 2008]
    }
  } else if (t == 2 | t == 3) {
    sampleHeight <- substr (temp [['sampleID']], 6, 6)
    if (sampleHeight == 'A') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at200']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at200']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at200']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at200']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    } else if (sampleHeight == 'B') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at100']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at100']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at100']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at100']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    }
  } else if (t == 4) {
    sampleHeight <- substr (temp [['sampleID']], 6, 6)
    if (sampleHeight == 'A') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at250']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at250']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at250']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }  
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at250']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    } else if (sampleHeight == 'M') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at150']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at150']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at150']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at150']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    } else if (sampleHeight == 'B') {
      if (!is.na (growth [years == 2017])) {
        ringWidths [['RW2017at050']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2017]
      }
      if (!is.na (growth [years == 2016])) {
        ringWidths [['RW2016at050']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2016]
      }
      if (!is.na (growth [years == 2015])) {
        ringWidths [['RW2015at050']] [ringWidths [['tree']] == treeID &
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2015]
      }
      if (!is.na (growth [years == 2014])) {
        ringWidths [['RW2014at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2014]
      }
      if (!is.na (growth [years == 2013])) {
        ringWidths [['RW2013at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2013]
      }
      if (!is.na (growth [years == 2012])) {
        ringWidths [['RW2012at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2012]
      }
      if (!is.na (growth [years == 2011])) {
        ringWidths [['RW2011at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2011]
      }
      if (!is.na (growth [years == 2010])) {
        ringWidths [['RW2010at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2010]
      }
      if (!is.na (growth [years == 2009])) {
        ringWidths [['RW2009at050']] [ringWidths [['tree']] == treeID & 
                                      ringWidths [['month']] == sampleDate] <- growth [years == 2009]
      }
    }
  }
}  # end json file loop

# add November ring width to the ringWidths tibble
for (i in 1:dim (data) [1]) {
  treeID       <- as.numeric (substr (data [['TREE']] [i], 1, 2))
  treatment    <- as.numeric (substr (data [['PLOT']] [i], 2, 2))
  sampleHeight <- data [['POS']] [i]
  sampleDate <- 11
  year <- data [['YEAR']] [i]
  if (sampleHeight == 'A' & treatment == 4) {
    height <- '250' 
  } else if (sampleHeight == 'A' & (treatment == 2 | treatment == 3)) {
    height <- '200' 
  } else if (sampleHeight == 'M') {
    height <- '150'
  } else if (sampleHeight == 'B' & (treatment == 2 | treatment == 3)) {
    height <- '100'
  } else if (sampleHeight == 'B' & treatment == 4) {
    height <- '050'
  }
  xTemp <- paste0 ('RW',year,'at',height)
  ringWidths [[xTemp]] [ringWidths [['tree']] == treeID & 
                        ringWidths [['month']] == sampleDate] <- as.numeric (data [['MRW']] [i]) * 1.0e-3
}

# Reset the working directory
setwd ('/home/trademacehr/projects/PlantGrowth/Exp2017/Exp2017Analysis/')
```


``` {r plotBasicRingStats, echo = FALSE}
# Divide into tibble for each sampling date
ringWidthsJul <- ringWidths [ringWidths [['month']] == 7, ]
ringWidthsAug <- ringWidths [ringWidths [['month']] == 8, ]
ringWidthsOct <- ringWidths [ringWidths [['month']] == 10, ]
ringWidthsNov <- ringWidths [ringWidths [['month']] == 11, ]
#max (ringWidths [4:dim (ringWidths) [2]], na.rm = TRUE)

# Get mean 2017 growth for each month for all treatments
# mean (colMeans (ringWidthsJul [4:8], na.rm = TRUE)) # 0.914724
# mean (colMeans (ringWidthsAug [4:8], na.rm = TRUE)) # 1.437826
# mean (colMeans (ringWidthsOct [4:8], na.rm = TRUE)) # 1.677127
# mean (colMeans (ringWidthsNov [4:8], na.rm = TRUE)) # 1.7327

# Get mean growth per treatment for each month
# colMeans (ringWidthsJul [ringWidthsJul [['treatment']] == 1, 4:8], na.rm = TRUE)
# colMeans (ringWidthsAug [ringWidthsAug [['treatment']] == 1, 4:8], na.rm = TRUE)
# colMeans (ringWidthsOct [ringWidthsOct [['treatment']] == 1, 4:8], na.rm = TRUE)
# colMeans (ringWidthsNov [ringWidthsNov [['treatment']] == 1, 4:8], na.rm = TRUE)


# colMeans (ringWidthsJul [ringWidthsJul [['treatment']] == 2, 4:8], na.rm = TRUE)
# colMeans (ringWidthsAug [ringWidthsAug [['treatment']] == 2, 4:8], na.rm = TRUE)
# colMeans (ringWidthsOct [ringWidthsOct [['treatment']] == 2, 4:8], na.rm = TRUE)
# colMeans (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 4:8], na.rm = TRUE)

# colMeans (ringWidthsJul [ringWidthsJul [['treatment']] == 3, 4:8], na.rm = TRUE)
# colMeans (ringWidthsAug [ringWidthsAug [['treatment']] == 3, 4:8], na.rm = TRUE)
# colMeans (ringWidthsOct [ringWidthsOct [['treatment']] == 3, 4:8], na.rm = TRUE)
# colMeans (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 4:8], na.rm = TRUE)

# colMeans (ringWidthsJul [ringWidthsJul [['treatment']] == 4, 4:8], na.rm = TRUE)
# colMeans (ringWidthsAug [ringWidthsAug [['treatment']] == 4, 4:8], na.rm = TRUE)
# colMeans (ringWidthsOct [ringWidthsOct [['treatment']] == 4, 4:8], na.rm = TRUE)
# colMeans (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 4:8], na.rm = TRUE)

dJul <- density (unlist (ringWidthsJul [4:8]), na.rm = T)
dAug <- density (unlist (ringWidthsAug [4:8]), na.rm = T)
dOct <- density (unlist (ringWidthsOct [4:8]), na.rm = T)
dNov <- density (unlist (ringWidthsNov [4:8]), na.rm = T)

# Plot density kernels
layout (matrix (1:3, nrow = 1))
par (mar = c (5, 5, 5, 1))
plot (dJul, xlab = 'ring width (mm)', ylab = 'density',
      xlim = c (0, 5.5), ylim = c (0, 1), main = '2017', 
      col = '#018571', lwd = 2, las = 1)
lines (dAug, col = '#80cdc1', lwd = 2)
lines (dOct, col = '#dfc27d', lwd = 2)
lines (dNov, col = '#a6611a', lwd = 2)
legend (x = 2.5, y = 1.02, legend = c ('July','August','October','November'),
        col = c ('#018571', '#80cdc1', '#dfc27d', '#a6611a'),
        lwd = 2, box.lty = 0, bg = 'transparent')

# Compare mean 2016 growth 
# mean (colMeans (ringWidthsJul [9:13], na.rm = TRUE))
# mean (colMeans (ringWidthsAug [9:13], na.rm = TRUE))
# mean (colMeans (ringWidthsOct [9:13], na.rm = TRUE))
# mean (colMeans (ringWidthsNov [9:13], na.rm = TRUE))
dJul <- density (unlist (ringWidthsJul [9:13]), na.rm = T)
dAug <- density (unlist (ringWidthsAug [9:13]), na.rm = T)
dOct <- density (unlist (ringWidthsOct [9:13]), na.rm = T)
dNov <- density (unlist (ringWidthsNov [9:13]), na.rm = T)
plot (dJul, xlab = 'ring width (mm)', ylab = 'density',
      xlim = c (0, 5.5), ylim = c (0, 0.5), main = '2016', 
      col = '#018571', lwd = 2, las = 1)
lines (dAug, col = '#80cdc1', lwd = 2)
lines (dOct, col = '#dfc27d', lwd = 2)
lines (dNov, col = '#a6611a', lwd = 2)
legend (x = 2.5, y = 0.51, legend = c ('July','August','October','November'),
        col = c ('#018571', '#80cdc1', '#dfc27d', '#a6611a'),
        lwd = 2, box.lty = 0, bg = 'transparent')

# Compare mean 2016 growth 
# mean (colMeans (ringWidthsJul [14:18], na.rm = TRUE))
# mean (colMeans (ringWidthsAug [14:18], na.rm = TRUE))
# mean (colMeans (ringWidthsOct [14:18], na.rm = TRUE))
# mean (colMeans (ringWidthsNov [14:18], na.rm = TRUE))
dJul <- density (unlist (ringWidthsJul [14:18]), na.rm = T)
dAug <- density (unlist (ringWidthsAug [14:18]), na.rm = T)
dOct <- density (unlist (ringWidthsOct [14:18]), na.rm = T)
dNov <- density (unlist (ringWidthsNov [14:18]), na.rm = T)
plot (dJul, xlab = 'ring width (mm)', ylab = 'density',
      xlim = c (0, 5.5), ylim = c (0, 0.5), main = '2015', 
      col = '#018571', lwd = 2, las = 1)
lines (dAug, col = '#80cdc1', lwd = 2)
lines (dOct, col = '#dfc27d', lwd = 2)
lines (dNov, col = '#a6611a', lwd = 2)
legend (x = 2.5, y = 0.51, legend = c ('July','August','October','November'),
        col = c ('#018571', '#80cdc1', '#dfc27d', '#a6611a'),
        lwd = 2, box.lty = 0, bg = 'transparent')

# Plot standardised ring widths in November to look for treatment effect in 2017
dNov1M <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 1, 6] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 1, 16]), na.rm = T)
dNov2A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 5] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 2, 15]), na.rm = T)
dNov2B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 7] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 2, 17]), na.rm = T)
dNov3A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 5] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 3, 15]), na.rm = T)
dNov3B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 7] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 3, 17]), na.rm = T)
dNov4A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 4] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 4, 14]), na.rm = T)
dNov4M <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 6] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 4, 16]), na.rm = T)
dNov4B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 8] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 4, 18]), na.rm = T)

# Plot density kernel of ring widths in 2017 and 2015 by treatment
par (mar = c (5,5,3,1))
layout (matrix (1:4, nrow = 2), height = c (1.5, 1, 1.5, 1))
plot (dNov1M, col = colours [1], lwd = 2, ylim = c (0, 2), las = 1,
      xlab = 'ring width (mm)',
      ylab = 'density', main = '2017',
      xlim = c (0, 3))
lines (dNov2A, col = colours [2], lwd = 2)
lines (dNov2B, col = colours [2], lwd = 2, lty = 2)
lines (dNov3A, col = colours [3], lwd = 2)
lines (dNov3B, col = colours [3], lwd = 2, lty = 2)
lines (dNov4A, col = colours [4], lwd = 2)
lines (dNov4B, col = colours [4], lwd = 2, lty = 2)
lines (dNov4M, col = colours [4], lwd = 2, lty = 3)
boxplot (at = 6, x = ringWidthsNov [ringWidthsNov [['treatment']] == 1, 6] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 1, 16], 
         col = colours [1], xlim = c (0, 7), ylim = c (0, 3),
         axes = FALSE, horizontal = TRUE)
boxplot (at = 5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 2, 5] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 2, 15], 
         col = colours [2], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 4.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 2, 7] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 2, 17], 
         col = colours [2], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 3.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 3, 5] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 3, 15], 
         col = colours [3], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 3, x = ringWidthsNov [ringWidthsNov [['treatment']] == 3, 7] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 3, 17], 
         col = colours [3], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 2, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 4] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 4, 14], 
         col = colours [4], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 1.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 6] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 4, 16], 
         col = colours [4], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 1, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 8] / 
                           ringWidthsNov [ringWidthsNov [['treatment']] == 4, 18], 
         col = colours [4], add = T, 
         axes = FALSE, horizontal = TRUE)

# Add a plot for 2015 
dNov1M <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 1, 16]), na.rm = T)
dNov2A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 15]), na.rm = T)
dNov2B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 2, 17]), na.rm = T)
dNov3A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 15]), na.rm = T)
dNov3B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 3, 17]), na.rm = T)
dNov4A <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 14]), na.rm = T)
dNov4M <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 16]), na.rm = T)
dNov4B <- density (unlist (ringWidthsNov [ringWidthsNov [['treatment']] == 4, 18]), na.rm = T)
par (mar = c (5,5,3,1))
plot (dNov1M, col = colours [1], lwd = 2, ylim = c (0, 1.2), las = 1,
      xlab = 'ring width (mm)',
      ylab = 'density', main = '2015',
      xlim = c (0, 6))
lines (dNov2A, col = colours [2], lwd = 2)
lines (dNov2B, col = colours [2], lwd = 2, lty = 2)
lines (dNov3A, col = colours [3], lwd = 2)
lines (dNov3B, col = colours [3], lwd = 2, lty = 2)
lines (dNov4A, col = colours [4], lwd = 2)
lines (dNov4B, col = colours [4], lwd = 2, lty = 2)
lines (dNov4M, col = colours [4], lwd = 2, lty = 3)
boxplot (at = 6, x = ringWidthsNov [ringWidthsNov [['treatment']] == 1, 16], 
         col = colours [1], xlim = c (0, 7), ylim = c (0, 6),
         axes = FALSE, horizontal = TRUE)
boxplot (at = 5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 2, 15], 
         col = colours [2], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 4.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 2, 17], 
         col = colours [2], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 3.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 3, 15], 
         col = colours [3], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 3, x = ringWidthsNov [ringWidthsNov [['treatment']] == 3, 17], 
         col = colours [3], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 2, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 14], 
         col = colours [4], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 1.5, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 16], 
         col = colours [4], add = T, 
         axes = FALSE, horizontal = TRUE)
boxplot (at = 1, x = ringWidthsNov [ringWidthsNov [['treatment']] == 4, 18], 
         col = colours [4], add = T, 
         axes = FALSE, horizontal = TRUE)

# Calculate the fractions of ring formed
f_Jul <- (ringWidthsJul [4:8] / ringWidthsJul [14:18]) * ringWidthsNov [14:18] / ringWidthsNov [4:8] 
f_Aug <- (ringWidthsAug [4:8] / ringWidthsAug [14:18]) * ringWidthsNov [14:18] / ringWidthsNov [4:8] 
f_Oct <- (ringWidthsOct [4:8] / ringWidthsOct [14:18]) * ringWidthsNov [14:18] / ringWidthsNov [4:8] 

# Samples with only a partial 2015 ring are currently set to NAs
# TR - I need to deal with November samples that only have a partial measurement of the 2015 ring (06.1M, 11.2A, 24.4A, 24.4B)

# Aggregate the fractional growth by treatment
f_Agg <- aggregate (f_Jul, mean, by = list (allometricData [['treatment']] [1:40]), na.rm = TRUE)
f_Agg <- rbind (f_Agg, aggregate (f_Aug, mean, by = list (allometricData [['treatment']] [1:40]), na.rm = TRUE))
f_Agg <- rbind (f_Agg, aggregate (f_Oct, mean, by = list (allometricData [['treatment']] [1:40]), na.rm = TRUE))
f_Agg <- cbind (f_Agg, c(rep (7, 4), rep (8, 4), rep (10,4)))
names (f_Agg) <- c ('treatment', names (f_Agg [,2:6]),'month')
```

On average, `r round (mean (unlist (f_Jul), na.rm = TRUE) * 100.0, 1)`%, `r round (mean (unlist (f_Aug), na.rm = TRUE) * 100.0, 1)`%, and `r round (mean (unlist (f_Oct), na.rm = TRUE) * 100.0, 1)`% of the ring width had respectively grown in July, August and October. Thus, a bit more than half of the ring widths was already formed before the start of the treatment and ring width growth had <i>de facto</i> finished by Ocotober. However, there were substantial differences between treatments and sampling heights.  

```{r tableWithNumberOfSamples, echo = FALSE, results = 'asis'}
# check how many trees with data I have for each year
numberOfSamples <- colSums (!is.na (ringWidths [,4:dim (ringWidths) [2]]), na.rm = T)
numberOfSamples <- c (sum (numberOfSamples [1:5]),   sum (numberOfSamples [6:10]),  
                      sum (numberOfSamples [11:15]), sum (numberOfSamples [16:20]),
                      sum (numberOfSamples [21:25]), sum (numberOfSamples [26:30]),
                      sum (numberOfSamples [31:35]), sum (numberOfSamples [36:40]), 
                      sum (numberOfSamples [41:55], na.rm = T), sum (numberOfSamples [46:50]))
names (numberOfSamples) <- c (2017:2008)
numberOfSamples <- rbind (numberOfSamples, round (numberOfSamples / 320 * 100, 2))
rownames (numberOfSamples) <- c ('Number of Samples', 'Percentage')

# Add mean ring widths for each year and maybe percentage of possible samples 
kable (numberOfSamples, caption = 'Number of measured growth ring widths for all trees out of a potential 328 thinsection images.')
```

<!-- ## Associate cell wall area in final ring with period

Using the fractional ring widths as boundaries, each sector was associated with one of the four periods: (i) beginning of growing season to start of experiment ($3^{rd}$ of July 2017), (ii) first month of the experiment ($4^{th}$ of July to $9^{th}$ of August 2017), (iii) second month of the experiment ($10^{th}$ of August to $9^{th}$ of October 2017), (iv) end of double compression to end of growing season ($10^{th}$ of October to $3^{rd}$ of November 2017). Sectors that were split by a period boundary, where fractionally added to both adjacent periods.

``` {r cellularData, echo = FALSE}

```

## Scaling measured cell wall area to stem section 

After we associated each 20-micron wide zone with a growth period, we scaled the cell wall area to the entire circumference of the stem section. Using ROXAS we also measured the average tangential cell width, which we used to scale the average cell wall area to the entire circumference of each stem section. To scale the circumeferential cell wall area to a cell wall volume per stem section, we assume that the measured area is representative circumferentially and taraplas for the stem section. We also assume that tracheids take up ??? % of the volume, hence we can simply multiply the circumferential cell wall area with the height of the stem section (h = 10cm) and a factor to correct for other types of cells (e.g., rays and resin ducts). Once the cell wall volume for each ring portion of the stem section is known, they are multiplied by a fixed cell wall density (1.489 $kgDM \, m^{−3}$ Scots pine from @plotze_porosity_2011) and carbon content of 49.74% for white pine [@lamlom_reassessment_2003] to estimate the amount of carbon sequestered in structural biomass for each period.

The cell wall area increment is scaled geometrically to the stem section’s cell wall volume increment in two steps, assuming that wood formed homogenously around the stem in each section and the above estimate is representative of the formed wood for each section and period. Using the stem section’s circumference, as measured at the beginning of the experiment ($CBH_{outer,s}$). First, the circumference is reduce assuming a bark thickness of 0.8 cm according to the following equation:

$$
CBH_{s} = CBH_{outer,s} − 0.8 cm \times 2 \pi
$$

Second, the reduced stem section circumference is divided by the radial width of the thinsection ($w_{r,s}$) and multiplied by the cell wall area increment () and the stem section height (here h=0.1m) to estimate the total volume of newly formed cell wall in each section and period ($V_{CW,s}$).

$$
V_{CW,s,p} = \frac {CBH_{s}} {w_{r,s}} \times h_{s}
$$

Finally, the cell wall volume of each section is multiplied with a cell wall density ($\rho_{CW}$) of 1.489 $kg m^{3}$ - a best estimate based on data for comparable softwoods, such as Scots pine, by @plotze_porosity_2011 - and an assumed carbon content of 49.74% for white pine [@lamlom_reassessment_2003] to estimate the total structural carbon gain per stem section and period ($M_{p,s}$ in g).

$$
M_{s,p} = V_{CW,s,p} \times \rho_{CW} \times 0.5
$$
-->
# References