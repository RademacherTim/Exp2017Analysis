---
title: 'Scaling nonstructural carbon reserves (SI 2)'
author: Tim Rademacher
date: "06/09/2019"
output: html_document
bibliography: "/home/tim/projects/PlantGrowth/bib/Exp2017.bib"
csl: "/home/tim/projects/PlantGrowth/bib/harvard.csl"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library ('tidyverse')
library ('readxl')
```

## Calculating nonstructural carbon reserves for the 2017 experiment at Harvard Forest

To estimate changes in soluble sugars and starch (measured as glucose equivalent) for various tissue, we scaled the concentrations derived using colorimetric assays as described in the methods. Below, we describe the scaling for easily accessible nonstrucutral carbon reserves in stem sections, for entire stem, roots and leaves, as well as the whole-tree reserves. The net differences in reserves over time (i.e., four sampling points) provide estimates of net gains or losses of soluble sugars and starch for each stem section, organ and tree. Generally, scaling involved multiplication of nonstructural carbon concentration by an estimate of tissue dry matter similar to @furze_whole-tree_2019. Below we provideexact methods and examples for each tissue.

## For stem sections

We measured nonstructural carbon concentrations for the first centimeter of the stem core (from the cambium towards the pith) as detailed in the methods section. While nonstructural carbon concentrations follow a generally decreasing gradient from the bark towards the pith [@hoch_non-structural_2003;furze_whole-tree_2018], we only consider nonstructural carbon reserves in the first centimeter underlying the bark for each stem section. We limit our analysis to these shallow reserves, because deeper reserves are assumed to less accessible [@carbone_age_2013],especially on timescales considered here (i.e. months).
<!-- The decline in @hoch_non-structural_2003 is actually more exponential than linear, but let's start with linear. Morgan might have better data for Pinus strobus that can help me scale more adequately.--> 

Assuming that the bulk of easily accessible nonstructural carbon can be found in the first centimeter and that our measurements are an accurate average of these reserves, we derive the total mass of nonstructural carbon in sugars and strach ($M_{sugar,i}$ and $M_{starch,i}$, respectively) by multiplying the dry matter of the hollow cylinder ($M_{i}$) of each stem section $i$ with the section's measured concentrations of sugar and starch ($c_{sugar,i}$ and $c_{starch,i}$, respectively). For sugar this is expressed as:

$$
 M_{sugar,i} = c_{sugar,i} \times M_{i} = V_{i} \times \rho_w \times c_{sugar,i}
$$
The mass of a hollow cylinder representing the outeter most centimeter of material is derived from its volume ($V_{i}$) and an average density of the wood ($\rho_w$). In turn the volume calculated using a height ($h$) of 10 cm and the section's circumference ($cbh_{i}$; in $cm$), which was measured in the field using a tape measure. Here, 289.9$\pm$ 40.4$kg \, m^{-3}$ was used as for the density of wood, which is the mean $\pm$ standard deviation of wood density of 16 cores from nine trees in the control group as determined using x-ray film [@bjorklund_scientific_2019].

$$
M_{i} = V_{i} \times \rho_{w} =  \pi \times h \times \rho_{w} \Big (\Big (\frac {cbh_{i}}{2 \pi}\Big)^2 - \Big (\frac {cbh_{i}}{2 \pi} - 0.01\Big)^2 \Big)
$$

``` {r calculateStemSectionNSCs, warning = FALSE}
# get the tree measurements of circumference from spreadsheet
#----------------------------------------------------------------------------------------
allometricData <- read_excel (path = '/media/tim/dataDisk/PlantGrowth/data/allometry/Exp2017/allometricDataExp2017.xlsx', 
                              sheet = 'allometricData', 
                              na = "NA")

# Declare the height of the stem section (h, m)
h <- 0.1

# Declare mean stem wood density (rho_s, kg m-3)
rho_w <- 289.9

# Determine the volume of each stem section (m3) at various height (0.5m, 1m, 1.5m, 2m, 2.5m)
# cbh is in cm, therefore divide by 100 and by 2.0 and pi to get the sections radius in m
allometricData <- add_column (allometricData,   
                          V50  = ((allometricData[['cbh50']]/(100.0*2.0*pi))^2.0*pi*h) - 
                                 ((allometricData[['cbh50']]/(100.0*2.0*pi)-0.01)^2.0*pi*h),
                          V100 = (allometricData[['cbh100']]/(100.0*2.0*pi))^2.0*pi*h - 
                                 ((allometricData[['cbh100']]/(100.0*2.0*pi)-0.01)^2.0*pi*h),
                          V150 = (allometricData[['cbh150']]/(100.0*2.0*pi))^2.0*pi*h - 
                                 ((allometricData[['cbh150']]/(100.0*2.0*pi)-0.01)^2.0*pi*h), 
                          V200 = (allometricData[['cbh200']]/(100.0*2.0*pi))^2.0*pi*h - 
                                 ((allometricData[['cbh200']]/(100.0*2.0*pi)-0.01)^2.0*pi*h),
                          V250 = (allometricData[['cbh250']]/(100.0*2.0*pi))^2.0*pi*h - 
                                 ((allometricData[['cbh250']]/(100.0*2.0*pi)-0.01)^2.0*pi*h))

# determine the mass of each stem section (Msection, kg)
#----------------------------------------------------------------------------------------
allometricData <- add_column (allometricData,
                          M50  = allometricData [['V50']]  * rho_w,
                          M100 = allometricData [['V100']] * rho_w,
                          M150 = allometricData [['V150']] * rho_w,
                          M200 = allometricData [['V200']] * rho_w,
                          M250 = allometricData [['V250']] * rho_w)
```

``` {r getSugarConcentration}
# read the sugar and starch concentration for needles, roots and first centimeter of wood
#----------------------------------------------------------------------------------------
suppressMessages (source (file = '/home/tim/projects/PlantGrowth/nonstructuralCarbon/processExpNSCData.R'))

# select only relevant data
#----------------------------------------------------------------------------------------
leafData2017 <- filter (leafData2017, treeID <= 40)
rootData2017 <- filter (rootData2017, treeID <= 40)
stemData2017 <- filter (stemData2017, treeID <= 40)

# create responseVariables tibble
#----------------------------------------------------------------------------------------
responseVariables <- tibble (year = 2017,
                             month    = c (rep (7, 40), rep (8, 40), 
                                           rep (10, 40), rep (11, 40)),
                             tree = rep (1:40, 4),
                             sugarW250 = NA, starchW250 = NA, sugarW200 = NA,	
                             starchW200 = NA,	sugarW150 = NA,	starchW150 = NA,	
                             sugarW100 = NA,	starchW100 = NA, sugarW50 = NA,	
                             starchW50 = NA, sugarNeedle = NA, starchNeedle = NA, 
                             sugarRoot = NA, starchRoot = NA)

# Wrangle data to get sugar and starch concentrations (g kg-1) for each section and 
# multiply the concentration by the dry mass of the section (kg) to obtain total sugar and 
# starch reserves (kg)
for (r in 1:dim (responseVariables) [1]) {
  treeID <- responseVariables [['tree']] [r]
  iMonth <- responseVariables [['month']] [r]
  
  # Tree is in the control group (treatment 1)
  if (unique (stemData2017 [['treatment']] [stemData2017 [['treeID']] == treeID]) == 1) {
    
    # Determine sugar reserves
    responseVariables [['sugarW150']] [r] <- 
      allometricData [['M150']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['sugar']] [stemData2017 [['treeID']] == treeID & 
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    # Determine starch reserves
    responseVariables [['starchW150']] [r] <- 
      allometricData [['M150']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['starch']] [stemData2017 [['treeID']] == treeID & 
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
  # Tree is in the girled or compressed group (treatment 2 or 3)
  } else if (unique (stemData2017 [['treatment']] [stemData2017 [['treeID']] == responseVariables [['tree']] [r]]) == 2 | unique (stemData2017 [['treatment']] [stemData2017 [['treeID']] == responseVariables [['tree']] [r]]) == 3) {
    
    # Determine sugar reserves
    responseVariables [['sugarW100']] [r] <- 
      allometricData [['M100']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['sugar']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 1 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    responseVariables [['sugarW200']] [r] <- 
      allometricData [['M200']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['sugar']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 2 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    # Determine starch reserves
    responseVariables [['starchW100']] [r] <- 
      allometricData [['M100']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['starch']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 1 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    responseVariables [['starchW200']] [r] <- 
      allometricData [['M200']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['starch']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 2 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    
  # Tree is in the double compression group (treatment 4)
  } else if (unique (stemData2017 [['treatment']] [stemData2017 [['treeID']] == responseVariables [['tree']] [r]]) == 4) {
    
    # Determine sugar reserves
    responseVariables [['sugarW50']] [r] <- 
      allometricData [['M50']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['sugar']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 0.5 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    responseVariables [['sugarW150']] [r] <- 
      allometricData [['M150']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['sugar']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 1.5 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    responseVariables [['sugarW250']] [r] <- 
      allometricData [['M250']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['sugar']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 2.5 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    
    # Determine starch reserves  
    responseVariables [['starchW50']] [r] <- 
      allometricData [['M50']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['starch']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 0.5 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    responseVariables [['starchW150']] [r] <- 
      allometricData [['M150']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['starch']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 1.5 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
    responseVariables [['starchW250']] [r] <- 
      allometricData [['M250']] [allometricData [['tree']] == treeID] * 
      (stemData2017 [['starch']] [stemData2017 [['treeID']] == treeID & 
                             stemData2017 [['sampleHeight']] == 2.5 &
                             month (stemData2017 [['date']]) == iMonth] / 100) * 1000
  
  }
}
```

## Total above ground biomass 

According to @jenkins_comprehensive_2004, we calcualted total aboveground biomass ($B; in \; kg$) from the diameter at breast height of tree $t$ ($d_{t}; in \; m$) as follows:

$$
B = exp (\beta_0 + \beta_1 \; ln \; d_{t})
$$

``` {r totalBiomass}
biomass04 <- exp (2.4800 + 2.4835 * log (allometricData [['cbh150']] [allometricData [['tree']] != 41] / pi))  
#biomass08 <- exp (-2.6177 + 2.4638 * log (allometricData [['cbh150']] / pi)) # with specific gravity < 0.45
#biomass08 <- exp (-3.0506 + 2.6465 * log (allometricData [['cbh150']] / pi)) # with specific gravity >= 0.45
#biomassxx <- 2.2874 * exp (0.1968 * (allometricData [['cbh150']] / pi)) # From peichl
```

with generic pine species (Pinus spp.) parameters of $\beta_0 = -2.4800$ and $\beta_1 = 2.4835$. This total biomass includes foliage, stemwood, bark and branches. To get tissue specific values for the mass of stemwood, bark and foliage we estimated the fraction of the total aboveground biomass in each tissue using parameters from Table 2 in @jenkins_comprehensive_2004 (i.e. for stemwood $\alpha_0 = –0.3737$ and $\alpha_1 = –1.8055$) and the following equation:

$$
f = exp (\alpha_0 + \frac {\alpha_1} {d_t})
$$
``` {r fractionalBiomass}
rootFraction <- exp (-1.5619 + ( 0.6614 / (allometricData [['cbh150']] [allometricData [['tree']] != 41] / pi)))
stemFraction <- exp (-0.3737 + (-1.8055 / (allometricData [['cbh150']] [allometricData [['tree']] != 41] / pi)))
barkFraction <- exp (-2.0980 + (-1.1432 / (allometricData [['cbh150']] [allometricData [['tree']] != 41] / pi)))
foliFraction <- exp (-2.9584 + ( 4.4766 / (allometricData [['cbh150']] [allometricData [['tree']] != 41] / pi)))
branFraction <- 1.0 - foliFraction - stemFraction - barkFraction

rootMass <- biomass04 * rootFraction
stemMass <- biomass04 * stemFraction
barkMass <- biomass04 * barkFraction
branMass <- biomass04 * branFraction
foliMass <- biomass04 * foliFraction
```

Branch biomass was calculated as the residual of total aboveground biomass and the three other organs estimated above. Here, the mean stem, bark, branch and foliage fractions were `r round (mean (stemFraction) * 100.0,1)`%, `r round (mean (barkFraction) * 100.0,1)`%, `r round (mean (branFraction) * 100.0,1)`%, and  `r round (mean (foliFraction) * 100.0,1)`%, respectively.

$$
f_{branches} = 1.0 - f_{foliage} - f_{stemwood} - f_{bark}
$$
Root biomass was also estimated as a fraction of total aboveground biomass with an average of `r round (mean (rootFraction) * 100.0,1)`%.

For each organ and the entire tree we multiplied the respecitve biomass with the average sugar and starch concentration (in $% dry weight$) derived from colourimetric assays. The total nonstructural carbon estimates are the sum of the mass of sugar and starch. 

```{r totalFoliage reserves}
# determine tissue sugar reserves
#----------------------------------------------------------------------------------------
responseVariables [['sugarRoot']]   <- rootData2017 [['sugar']] * rootMass
responseVariables [['sugarNeedle']] <- leafData2017 [['sugar']] * foliMass

# determine tissue starch reserves
#----------------------------------------------------------------------------------------
responseVariables [['starchRoot']]   <- rootData2017 [['starch']] * rootMass
responseVariables [['starchNeedle']] <- leafData2017 [['starch']] * foliMass
# TR I could also calculate sugar in branches and bark in the future with the samples we still have at NAU. Furthermore, I could average the stem section of the control to derive stem values.

# export data if necessary
#----------------------------------------------------------------------------------------
WRITE <- TRUE
if (WRITE) write_csv (responseVariables,  path = 'nonstructuralCarbon.csv')
```

<!-- Finally, the whole-tree nonstructural carbon reserve  ($R_{NSC,t}$) in tree $t$ is the sum of the sugar and starch reserves in all five tissues (i.e. roots, stems, bark, branches, and leaves).  -->

<!-- $$ -->
<!-- R_{NSC,t} = \sum_{i=1}^{5} (R_{sugar,i} + R_{starch,i}) -->
<!-- $$ -->

# References