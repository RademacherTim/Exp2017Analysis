---
title: "SI - respiratory losses"
author: Tim Rademacher
date: "21/03/2019"
output: html_document
bibliography: /Volumes/added_SSD/projects/NSF-DB_plant_growth/bib/Exp2017.bib
csl: /Volumes/added_SSD/projects/NSF-DB_plant_growth/bib/harvard.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library ('tidyverse')
library ('lubridate')
```

## Calculating respiratory losses of stem sections for the 2017 experiment at Harvard Forest

This document details the methodology to convert weekly stem respiration rates measured on 40 white pines in the Tom's Swamp tract at Harvard Forest to total loss of carbon in grams due to stem respiration for five periods in between four measurements (e.g. baseline, one month into experiment, three months into experiment, and end of the growing seaon). Conceptually, the rates measured are integrated across time (e.g. the respective period) and space (e.g. a 10 cm stem section) for each tree to derive a total value of lost carbon in grams per stem section per tree. 

# Spatial integration over a 10cm stem section

To integrate the measured respiration rates across a 10cm stem section, we first calculate the surface area of each stem section.

```{r integrateAcrossSpace}
# Read tree stats (in particular dbh)
trees <- read_csv ('../../data/trees/2017ExperimentalDataPredictors.csv', col_types = cols ())

# Determine the circumference at breast height (cbh; cm)
trees$cbh <- trees$dbh150 * pi

# Determine the surface area of each stem section (Asection; m2)
trees$Asection <- (trees$cbh/100.0) * 0.1

# Read 2017 respiration rates derived using RespChamberProc package.
respRates2017 <- read_csv ('../../data/respiration/resp_compression_2017_11_01.csv', col_types = cols ())
respRates2017 <- respRates2017 [-1, ]

# Integrate the respiration rate over space 
respRates2017$flux_g_day <- NA
for (tree in 1:40) {
  respRates2017$flux_g_day [respRates2017$tree == tree] <- respRates2017$flux_g [respRates2017$tree == tree] * trees$Asection [trees$tree == tree]
}
```

# Integrate across time

We approximate the total loss of carbon across each period by multiplying the geometric mean of spatially integrated respiration rates (g day-1) measured during each period by the length of the period (days).

``` {r temporalIntegration}
# Associate treatements with trees and colours
controlTrees <- c ( 1,  3,  4,  6,  7,  9, 18, 30, 31, 36)
girdledTrees <- c ( 5, 11, 15, 16, 19, 23, 29, 35, 39, 40, 41)
compresTrees <- c (10, 12, 13, 17, 20, 21, 28, 32, 33, 38)
doubleCTrees <- c ( 2,  8, 14, 22, 24, 25, 26, 27, 34, 37)

# Set period boundaries
boundaries <- as.POSIXct (c ('2017-07-05','2017-08-10','2017-10-09','2017-11-01'), tz = 'EST')

# Calculate the geometric mean for each period for each stem section
for (period in 1:4) {
  if (period == 1) {
    periodData <- filter (respRates2017, respRates2017$date <= boundaries [period])
    pLen <- boundaries [period] - as.POSIXct (min (periodData$date), tz = 'EST')
  } else if (period > 1 & period < 5) {
    periodData <- filter (respRates2017, respRates2017$date >  boundaries [period-1] & 
                                         respRates2017$date <= boundaries [period])
    pLen <- boundaries [period] - boundaries [period-1]
  } else {
    periodData <- filter (respRates2017, respRates2017$date >  boundaries [period])
    pLen <- as.POSIXct (max (periodData$date, na.rm = T), tz = 'EST') - boundaries [period]
  }
  
  # Aggregate the mean respiration over each period by chamber and tree (g day-1)
  tmpResp <- periodData %>% 
    group_by (tree, chamber) %>% 
    summarize (meanResp = mean (flux_g_day, na.rm = T))
  
  # Add a period column to temporary tibble
  tmpResp$period <- period
  
  # Multiply mean respiration rate by length of period to get the total respiratory carbon loss (g period-1)
  tmpResp$totalResp <- tmpResp$meanResp * as.numeric (pLen, 'days')
  
  # Add the period specific data to a global tibble
  if (period == 1){
    respTemp <- tmpResp
  } else {
    respTemp <- rbind (respTemp, tmpResp)
  }
}
# Add treatment to tmoResp
respTemp$treatment <- NA
res <- sapply (controlTrees, function (x) {respTemp$treatment [which (respTemp$tree == x)] <<- 1}); rm (res)
res <- sapply (girdledTrees, function (x) {respTemp$treatment [which (respTemp$tree == x)] <<- 2}); rm (res)
res <- sapply (compresTrees, function (x) {respTemp$treatment [which (respTemp$tree == x)] <<- 3}); rm (res)
res <- sapply (doubleCTrees, function (x) {respTemp$treatment [which (respTemp$tree == x)] <<- 4}); rm (res)
```

``` {r plotRespiratoryLosses, echo = F}
colour <- c ('gray','darkred','cyan4','#91b9a4')

# Declare function to draw a line
drawLine <- function (data, treeID, chamberID) {
  xs <- data$period    [data$tree == treeID & data$chamber == chamberID]
  ys <- data$meanResp  [data$tree == treeID & data$chamber == chamberID]
  i  <- unique (data$treatment [data$tree == treeID & data$chamber == chamberID])
  lines (x = xs,
         y = ys,
         lwd = 1,
         lty = chamberID,
         col = colour [i])
}

# Plot all tree and chamber combinations over the periods
par (mfrow = c (2, 2))
plot (x = respTemp$period   [respTemp$tree == 1 & respTemp$chamber == 1],
      y = respTemp$meanResp [respTemp$tree == 1 & respTemp$chamber == 1],
      xaxt = 'n',
      typ = 'l',
      lwd = 1,
      las = 1,
      col = 'white',
      xlab = 'period',
      ylab = 'mean respiration rate (g day-1)',
      ylim = c (0, 0.45))
axis (1, labels = c ('1','2','3','4'), at = 1:4)
res <- sapply (controlTrees, drawLine, data = respTemp, chamberID = 1)

plot (x = respTemp$period   [respTemp$tree == 1 & respTemp$chamber == 1],
      y = respTemp$meanResp [respTemp$tree == 1 & respTemp$chamber == 1],
      xaxt = 'n',
      typ = 'l',
      lwd = 1,
      las = 1,
      col = 'white',
      xlab = 'period',
      ylab = 'mean respiration rate (g day-1)',
      ylim = c (0, 0.45))
axis (1, labels = c ('1','2','3','4'), at = 1:4)
res <- sapply (girdledTrees, drawLine, data = respTemp, chamberID = 1)
res <- sapply (girdledTrees, drawLine, data = respTemp, chamberID = 2)

plot (x = respTemp$period   [respTemp$tree == 1 & respTemp$chamber == 1],
      y = respTemp$meanResp [respTemp$tree == 1 & respTemp$chamber == 1],
      xaxt = 'n',
      typ = 'l',
      lwd = 1,
      las = 1,
      col = 'white',
      xlab = 'period',
      ylab = 'mean respiration rate (g day-1)',
      ylim = c (0, 0.45))
axis (1, labels = c ('1','2','3','4'), at = 1:4)
res <- sapply (compresTrees, drawLine, data = respTemp, chamberID = 1)
res <- sapply (compresTrees, drawLine, data = respTemp, chamberID = 2)

plot (x = respTemp$period   [respTemp$tree == 1 & respTemp$chamber == 1],
      y = respTemp$meanResp [respTemp$tree == 1 & respTemp$chamber == 1],
      xaxt = 'n',
      typ = 'l',
      lwd = 1,
      las = 1,
      col = 'white',
      xlab = 'period',
      ylab = 'mean respiration rate (g day-1)',
      ylim = c (0, 0.45))
axis (1, labels = c ('1','2','3','4'), at = 1:4)
res <- sapply (doubleCTrees, drawLine, data = respTemp, chamberID = 1)
res <- sapply (doubleCTrees, drawLine, data = respTemp, chamberID = 2)
res <- sapply (doubleCTrees, drawLine, data = respTemp, chamberID = 3)
```

``` {r createOutput, echo = F}
# Create empty tibble 
output <- tibble (year = 2017, 
                  months = c (rep ('July', 40), rep ('August', 40), rep ('October', 40), rep ('November', 40)),
                  tree = rep (1:40, 4),
                  resp250 = NA,
                  resp200 = NA,
                  resp150 = NA,
                  resp100 = NA, 
                  resp050 = NA)

# Fill tibble row by row 
nmo <- c ('July', 'August','October', 'November')
for (r in 1:dim (respTemp) [1]) {
  if (respTemp$treatment [r] == 1) { # control
    output$resp150 [output$tree   == respTemp$tree [r] & 
                    output$months == nmo [respTemp$period [r]]] <- respTemp$meanResp [r]
  } else if ((respTemp$treatment [r] == 2 | respTemp$treatment [r] == 3) & respTemp$chamber [r] == 1) { # girdled and compressed
    output$resp100 [output$tree   == respTemp$tree [r] & 
                    output$months == nmo [respTemp$period [r]]] <- respTemp$meanResp [r]
  } else if ((respTemp$treatment [r] == 2 | respTemp$treatment [r] == 3) & respTemp$chamber [r] == 2) { # girdled and compressed
    output$resp200 [output$tree   == respTemp$tree [r] & 
                    output$months == nmo [respTemp$period [r]]] <- respTemp$meanResp [r]
  } else if (respTemp$treatment [r] == 4 & respTemp$chamber [r] == 1) { # double compressed
    output$resp050 [output$tree   == respTemp$tree [r] & 
                    output$months == nmo [respTemp$period [r]]] <- respTemp$meanResp [r]
  } else if (respTemp$treatment [r] == 4 & respTemp$chamber [r] == 2) { # double compressed
    output$resp150 [output$tree   == respTemp$tree [r] & 
                    output$months == nmo [respTemp$period [r]]] <- respTemp$meanResp [r]
  } else if (respTemp$treatment [r] == 4 & respTemp$chamber [r] == 3) { # double compressed
    output$resp250 [output$tree   == respTemp$tree [r] & 
                    output$months == nmo [respTemp$period [r]]] <- respTemp$meanResp [r]
  }
}
write_csv (output, 'respOutput.csv')
```

### To-do list and comments

- adjust the cbh by height to get circumference of the actual section rather than at breast height. Either by measuring or by a taper factor.
- add the 2018 data and therefore a fifth period.
- change plots to range with treatment mean as a line.
- check how the graphs look different with a temperature correction using Q10.

# References